PolicyGraph: Cleaning up threats older than 30 days (cutoff: 1759267349000)
====================================
  Phase 3 Integration Tests
====================================
✅ PolicyGraph initialized at /tmp/sentinel_phase3_test

=== Test 1: Block Policy Enforcement ===
  Created block policy ID: 1
  First EICAR detection matched policy ID: 1 (Action: Block)
  Second EICAR detection automatically blocked (no prompt)
  Verified 1 threat(s) logged in history
✅ PASSED: Block Policy Enforcement

=== Test 2: Policy Matching Priority ===
  Created policies: Hash=2, URL=3, Rule=4
  ✓ Priority 1: Hash policy matched (ID=2, Action=Block)
  ✓ Priority 2: URL pattern policy matched (ID=3, Action=Quarantine)
  ✓ Priority 3: Rule name policy matched (ID=4, Action=Allow)
✅ PASSED: Policy Matching Priority

=== Test 3: Quarantine Workflow ===
  Created quarantine policy ID: 5
  Matched quarantine policy (Action: Quarantine)
  Recorded quarantine action in threat history
  Verified quarantine action logged (ID=2)
✅ PASSED: Quarantine Workflow

=== Test 4: Policy CRUD Operations ===
  CREATE: Created policy ID 6
  READ: Retrieved policy (Rule: CRUD_Test_Ruleha0, Action: Allow)
  UPDATE: Changed action to Block and MIME type to executable
  DELETE: Successfully removed policy ID 6
✅ PASSED: Policy CRUD Operations

=== Test 5: Threat History ===
  Recorded 3 threats to history
  Retrieved 5 total threat records
  Retrieved 2 threats for rule 'Test_Malware_Rule'
  Verified history ordered by detection time (newest first)
  Total threats in database: 5
✅ PASSED: Threat History

====================================
  Test Summary
====================================
  Passed: 5
  Failed: 0
  Total:  5
====================================

✅ All tests PASSED!

Database location: /tmp/sentinel_phase3_test/policy_graph.db
