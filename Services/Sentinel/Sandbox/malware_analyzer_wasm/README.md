# WASM Malware Analyzer Module

Rust WASM module for sandboxed malware analysis in Ladybird Browser's Sentinel security system.

## Overview

This module provides fast, isolated file analysis with:
- **YARA-like pattern matching**: Detects 24 suspicious patterns across high/medium/low severity
- **ML feature extraction**: Shannon entropy, PE anomaly detection, code ratio analysis
- **Sandboxed execution**: Runs in Wasmtime with 128MB memory limit and fuel-based timeout
- **Performance**: Target <100ms for 1MB files

## Architecture

```
┌──────────────────────────────────────────┐
│ WASM Module (malware_analyzer.wasm)     │
├──────────────────────────────────────────┤
│ Exports:                                 │
│  • get_version() -> u32                  │
│  • allocate(size) -> ptr                 │
│  • deallocate(ptr, size)                 │
│  • analyze_file(ptr, len) -> result_ptr  │
├──────────────────────────────────────────┤
│ Detection Engine:                        │
│  • Pattern matching (24 patterns)        │
│  • Shannon entropy calculation           │
│  • PE header anomaly detection           │
│  • ML heuristic scoring                  │
├──────────────────────────────────────────┤
│ Imports (from host):                     │
│  • log(level, ptr, len)                  │
│  • current_time_ms() -> u64              │
└──────────────────────────────────────────┘
```

## Build

### Prerequisites

```bash
# Install Rust and WASM target
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
rustup target add wasm32-unknown-unknown
```

### Build Optimized Module

```bash
# Build with size optimization
cargo build --release --target wasm32-unknown-unknown

# Output: target/wasm32-unknown-unknown/release/malware_analyzer_wasm.wasm
# Expected size: ~50-60KB
```

### Install

```bash
# Copy to Sentinel assets directory
mkdir -p ../../assets
cp target/wasm32-unknown-unknown/release/malware_analyzer_wasm.wasm \
   ../../assets/malware_analyzer.wasm
```

### Verify Build

```bash
# Check module size
ls -lh target/wasm32-unknown-unknown/release/malware_analyzer_wasm.wasm

# Install wasmtime CLI (optional)
cargo install wasmtime-cli

# Verify module exports
wasm-objdump -x target/wasm32-unknown-unknown/release/malware_analyzer_wasm.wasm | grep -A 20 "Export\["
```

## Module Interface

### Exported Functions

```c
// Get module version (0x00050000 for v0.5.0)
uint32_t get_version(void);

// Allocate memory in WASM linear memory
// Returns pointer (0 if OOM)
int32_t allocate(uint32_t size);

// Deallocate memory (no-op for bump allocator)
void deallocate(int32_t ptr, uint32_t size);

// Analyze file data
// Returns pointer to AnalysisResult (0 if failed)
int32_t analyze_file(int32_t file_ptr, uint32_t file_len);
```

### Result Structure

```c
typedef struct {
    float yara_score;           // 0.0-1.0 (pattern-based score)
    float ml_score;             // 0.0-1.0 (ML heuristic score)
    uint32_t detected_patterns; // Count of matched patterns
    uint64_t execution_time_us; // Execution time in microseconds
    uint32_t error_code;        // 0 = success, non-zero = error
    uint32_t padding;           // Alignment padding
} __attribute__((packed)) AnalysisResult;
```

## Detection Features

### Pattern Database (24 patterns)

**High Severity (15 points each)**:
- Windows API calls: `VirtualAlloc`, `VirtualProtect`, `WriteProcessMemory`, `CreateRemoteThread`
- Function resolution: `LoadLibrary`, `GetProcAddress`
- Thread manipulation: `NtSetContextThread`, `SetWindowsHookEx`, `ZwUnmapViewOfSection`, `RtlCreateUserThread`

**Medium Severity (5 points each)**:
- Network indicators: `http://`, `https://`, `ftp://`
- Command execution: `cmd.exe`, `powershell`, `bash`, `/bin/sh`

**Low Severity (2 points each)**:
- Code execution: `eval(`, `exec(`
- Encoding: `base64`
- Crypto: `encrypt`, `decrypt`, `bitcoin`, `wallet`

### ML Features

1. **Shannon Entropy**: Detects packed/encrypted files (high entropy > 7.0)
2. **PE Anomalies**: Invalid headers, unusual section counts
3. **Code Ratio**: Suspicious printable-to-binary ratios

### Scoring Algorithm

```
YARA Score = (Σ pattern_severity) / 150.0
  - High severity: 15 points
  - Medium severity: 5 points
  - Low severity: 2 points
  - Capped at 1.0

ML Score = entropy_score + pe_score + code_ratio_score
  - Entropy > 7.0: +0.3
  - PE anomalies > 20: +0.25
  - Code ratio outliers: +0.15
  - Capped at 1.0
```

## Performance Characteristics

### Target Performance
- **1MB file**: <100ms total analysis
- **10MB file**: <500ms total analysis
- **Memory usage**: <10MB heap allocation

### Optimizations
- **Code size**: `-Oz` optimization, LTO enabled, symbols stripped
- **Execution speed**: Single-pass algorithms, minimal allocations
- **Memory**: Bump allocator (no fragmentation), fixed pattern database

## Integration Example

```cpp
// C++ host code (WasmExecutor)

// 1. Load module
wasmtime_module_t* module = load_wasm_module("malware_analyzer.wasm");

// 2. Get exports
wasmtime_func_t allocate_func, analyze_func;
get_export(store, &instance, "allocate", &allocate_func);
get_export(store, &instance, "analyze_file", &analyze_func);

// 3. Allocate buffer in WASM memory
int32_t file_ptr = call_allocate(allocate_func, file_size);

// 4. Copy file data to WASM memory
uint8_t* wasm_mem = wasmtime_memory_data(store, &memory);
memcpy(wasm_mem + file_ptr, file_data, file_size);

// 5. Call analyze_file
int32_t result_ptr = call_analyze(analyze_func, file_ptr, file_size);

// 6. Read result
AnalysisResult* result = (AnalysisResult*)(wasm_mem + result_ptr);
printf("YARA: %.2f, ML: %.2f\n", result->yara_score, result->ml_score);
```

## Development

### File Structure

```
src/
├── lib.rs           # Module exports and panic handler
├── allocator.rs     # Bump allocator (127MB heap)
├── patterns.rs      # Pattern database and matching
├── ml.rs            # Entropy and ML scoring
└── analysis.rs      # Main analysis orchestration
```

### Adding Patterns

Edit `src/patterns.rs`:

```rust
pub const HIGH_SEVERITY_PATTERNS: &[Pattern] = &[
    Pattern { name: "MyPattern", pattern: b"suspicious", severity: 15 },
    // ...
];
```

### Testing

```bash
# Build in debug mode
cargo build --target wasm32-unknown-unknown

# Run tests (requires host test harness)
# TODO: Add integration tests
```

## Troubleshooting

### Build Errors

**Error: `wasm32-unknown-unknown` target not found**
```bash
rustup target add wasm32-unknown-unknown
```

**Error: Module too large (>100KB)**
- Check optimization flags in `Cargo.toml`
- Use `wasm-opt -Oz` for further size reduction
- Profile with `cargo bloat --target wasm32-unknown-unknown --release`

### Runtime Errors

**Error: OOM during allocation**
- File too large (>10MB)
- Reduce pattern database size
- Check heap bounds in `allocator.rs`

**Error: Analysis timeout**
- Increase fuel limit in `WasmExecutor`
- Optimize pattern matching algorithms
- Profile with `cargo flamegraph`

## References

- [WASM Module Specification](../../../docs/WASM_MODULE_SPECIFICATION.md)
- [Sandbox Architecture](../../../docs/SANDBOX_ARCHITECTURE.md)
- [Milestone 0.5 Plan](../../../docs/MILESTONE_0.5_PLAN.md)

## License

Part of Ladybird Browser - BSD 2-Clause License

## Version History

- **0.5.0** (2025-11-01): Initial implementation
  - 24 pattern database
  - Shannon entropy calculation
  - PE header anomaly detection
  - ML heuristic scoring
  - Bump allocator (127MB heap)
