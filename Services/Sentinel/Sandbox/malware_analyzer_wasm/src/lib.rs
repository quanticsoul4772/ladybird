#![no_std]

mod allocator;
mod patterns;
mod ml;
mod analysis;

use allocator::{alloc, dealloc};
use analysis::analyze_file_internal;

// Version: 0.5.0 (0x00050000)
const VERSION: u32 = 0x00050000;

#[repr(C)]
#[derive(Copy, Clone)]
pub struct AnalysisResult {
    pub yara_score: f32,
    pub ml_score: f32,
    pub detected_patterns: u32,
    pub execution_time_us: u64,
    pub error_code: u32,
    pub padding: u32,
}

// Imported functions from host
extern "C" {
    #[allow(dead_code)]
    fn log(level: u32, ptr: i32, len: i32);
    #[allow(dead_code)]
    fn current_time_ms() -> u64;
}

#[no_mangle]
pub extern "C" fn get_version() -> u32 {
    VERSION
}

#[no_mangle]
pub extern "C" fn allocate(size: u32) -> i32 {
    alloc(size as usize) as i32
}

#[no_mangle]
pub extern "C" fn deallocate(ptr: i32, size: u32) {
    dealloc(ptr as *mut u8, size as usize);
}

#[no_mangle]
pub extern "C" fn analyze_file(ptr: i32, len: u32) -> i32 {
    // Safety: Caller guarantees valid pointer and length
    let file_data = unsafe {
        core::slice::from_raw_parts(ptr as *const u8, len as usize)
    };

    let result = analyze_file_internal(file_data);

    // Allocate result structure
    let result_ptr = alloc(core::mem::size_of::<AnalysisResult>()) as *mut AnalysisResult;
    if result_ptr.is_null() {
        return 0; // OOM
    }

    unsafe {
        *result_ptr = result;
    }

    result_ptr as i32
}

#[panic_handler]
fn panic(_info: &core::panic::PanicInfo) -> ! {
    loop {}
}
