# nsjail Configuration for Malware Analysis Sandbox
# Ladybird Browser - Sentinel Service
# Protocol Buffer Text Format
#
# This configuration provides strong isolation for analyzing potentially
# malicious code in a sandboxed environment with strict resource limits
# and restricted syscall access via seccomp-bpf.
#
# Usage:
#   nsjail --config malware-sandbox.cfg -- /path/to/suspicious/binary
#
# References:
#   - https://github.com/google/nsjail
#   - https://nsjail.dev/

# ==============================================================================
# Basic Configuration
# ==============================================================================

# Execution mode: ONCE = Single execution, exit after completion
mode: ONCE

# Hostname visible inside the sandbox
hostname: "malware-sandbox"

# Current working directory inside the sandbox
cwd: "/tmp"

# Time limit for the entire jail execution (wall clock time)
time_limit: 5

# Verbose logging for debugging (0=quiet, 1=normal, 2=verbose)
log_level: INFO

# ==============================================================================
# Namespace Isolation
# ==============================================================================

# Clone new process ID namespace (isolated PID tree)
clone_newpid: true

# Clone new mount namespace (isolated filesystem view)
clone_newns: true

# Clone new UTS namespace (isolated hostname/domainname)
clone_newuts: true

# Clone new IPC namespace (isolated SysV IPC, POSIX message queues)
clone_newipc: true

# Clone new network namespace (isolated network stack, no network by default)
clone_newnet: true

# Clone new user namespace (UID/GID remapping)
clone_newuser: true

# Clone new cgroup namespace (isolated cgroup view)
clone_newcgroup: true

# ==============================================================================
# User/Group Mapping
# ==============================================================================

# Map root in sandbox to nobody outside (UID 65534)
uidmap {
  inside_id: "0"
  outside_id: "65534"
  count: 1
}

# Map root group in sandbox to nogroup outside (GID 65534)
gidmap {
  inside_id: "0"
  outside_id: "65534"
  count: 1
}

# ==============================================================================
# Resource Limits (rlimit)
# ==============================================================================

# Address space limit: 256 MB virtual memory
rlimit_as: 268435456

# CPU time limit: 5 seconds of CPU time
rlimit_cpu: 5

# Open file descriptors limit: 64 file descriptors max
rlimit_nofile: 64

# File size limit: 10 MB max file write size
rlimit_fsize: 10485760

# Maximum number of processes/threads: 16
rlimit_nproc: 16

# Stack size limit: 8 MB
rlimit_stack: 8388608

# Core dump size: 0 (no core dumps)
rlimit_core: 0

# ==============================================================================
# Filesystem Mounts
# ==============================================================================

# Mount tmpfs at /tmp (read-write, 64 MB size limit)
mount {
  src: "none"
  dst: "/tmp"
  fstype: "tmpfs"
  options: "size=67108864"
  rw: true
  is_bind: false
}

# Mount /proc (required for many binaries)
mount {
  src: "/proc"
  dst: "/proc"
  fstype: "proc"
  rw: false
  is_bind: false
}

# Bind mount /lib (read-only, for shared libraries)
mount {
  src: "/lib"
  dst: "/lib"
  is_bind: true
  rw: false
  mandatory: false
}

# Bind mount /lib64 (read-only, for 64-bit shared libraries)
mount {
  src: "/lib64"
  dst: "/lib64"
  is_bind: true
  rw: false
  mandatory: false
}

# Bind mount /usr/lib (read-only, for additional libraries)
mount {
  src: "/usr/lib"
  dst: "/usr/lib"
  is_bind: true
  rw: false
  mandatory: false
}

# Bind mount /bin (read-only, for basic utilities)
mount {
  src: "/bin"
  dst: "/bin"
  is_bind: true
  rw: false
  mandatory: false
}

# Bind mount /usr/bin (read-only, for utilities)
mount {
  src: "/usr/bin"
  dst: "/usr/bin"
  is_bind: true
  rw: false
  mandatory: false
}

# Mount /dev (minimal device nodes)
mount {
  src: "/dev"
  dst: "/dev"
  is_bind: true
  rw: false
  mandatory: true
}

# ==============================================================================
# Seccomp-BPF Policy
# ==============================================================================

# Use Kafel seccomp policy file for syscall filtering
seccomp_string: "
POLICY malware_sandbox {
  # Allow basic file I/O
  ALLOW {
    read,
    write,
    open,
    openat,
    close,
    stat,
    fstat,
    lstat,
    stat64,
    fstat64,
    lstat64,
    newfstatat,
    statx
  },

  # Allow memory management
  ALLOW {
    mmap,
    mmap2,
    munmap,
    mprotect,
    mremap,
    brk,
    madvise
  },

  # Allow process control (limited)
  ALLOW {
    exit,
    exit_group,
    getpid,
    getppid,
    gettid,
    getuid,
    geteuid,
    getgid,
    getegid,
    getuid32,
    geteuid32,
    getgid32,
    getegid32
  },

  # Allow signal handling
  ALLOW {
    rt_sigreturn,
    rt_sigprocmask,
    rt_sigaction,
    sigreturn,
    sigprocmask,
    sigaction
  },

  # Allow directory operations
  ALLOW {
    getcwd,
    chdir,
    getdents,
    getdents64,
    readdir
  },

  # Allow time operations
  ALLOW {
    clock_gettime,
    gettimeofday,
    time,
    nanosleep,
    clock_nanosleep
  },

  # Allow minimal I/O multiplexing
  ALLOW {
    select,
    pselect6,
    poll,
    ppoll,
    epoll_create,
    epoll_create1,
    epoll_ctl,
    epoll_wait,
    epoll_pwait
  },

  # Allow file metadata operations
  ALLOW {
    access,
    faccessat,
    faccessat2,
    readlink,
    readlinkat,
    lseek,
    _llseek
  },

  # Allow thread-local storage
  ALLOW {
    set_thread_area,
    get_thread_area,
    set_tid_address,
    arch_prctl
  },

  # Allow resource limit queries
  ALLOW {
    getrlimit,
    ugetrlimit,
    prlimit64
  },

  # Allow futex operations (for threading)
  ALLOW {
    futex,
    set_robust_list,
    get_robust_list
  },

  # Log suspicious network operations
  LOG {
    socket,
    connect,
    bind,
    listen,
    accept,
    accept4,
    sendto,
    recvfrom,
    sendmsg,
    recvmsg,
    sendmmsg,
    recvmmsg,
    shutdown,
    setsockopt,
    getsockopt
  },

  # Log process creation attempts
  LOG {
    execve,
    execveat,
    fork,
    vfork,
    clone,
    clone3
  },

  # Log debugging attempts
  LOG {
    ptrace,
    process_vm_readv,
    process_vm_writev
  },

  # Log kernel module operations
  LOG {
    init_module,
    finit_module,
    delete_module
  },

  # Return EPERM for privilege escalation attempts
  ERRNO(1) {
    setuid,
    setuid32,
    setgid,
    setgid32,
    setreuid,
    setreuid32,
    setregid,
    setregid32,
    setresuid,
    setresuid32,
    setresgid,
    setresgid32,
    setfsuid,
    setfsuid32,
    setfsgid,
    setfsgid32,
    capset,
    prctl
  },

  # Return EPERM for filesystem modification attempts
  ERRNO(1) {
    mount,
    umount,
    umount2,
    pivot_root,
    chroot,
    unshare
  },

  # Return EPERM for namespace manipulation
  ERRNO(1) {
    setns
  },

  # Default action: KILL process on unknown syscall
  DEFAULT KILL
}
"

# Alternative: Load from external Kafel file
# seccomp_string: "@/path/to/malware-sandbox.kafel"

# ==============================================================================
# Additional Security Settings
# ==============================================================================

# Keep all capabilities (root capabilities dropped by default in user namespace)
keep_caps: false

# Silent mode: don't report violations to stderr
silent: false

# Skip /proc/self/setgroups disable (needed for some glibc versions)
disable_no_new_privs: false

# ==============================================================================
# Environment Variables
# ==============================================================================

envar: "PATH=/usr/bin:/bin"
envar: "HOME=/tmp"
envar: "USER=nobody"
envar: "LOGNAME=nobody"
envar: "SHELL=/bin/sh"

# Clear other environment variables for security
keep_env: false

# ==============================================================================
# Execution Configuration
# ==============================================================================

# Don't daemonize nsjail
daemon: false

# Pass stdin/stdout/stderr to sandboxed process
pass_fd: 0
pass_fd: 1
pass_fd: 2

# Maximum buffer size for stdin/stdout/stderr redirection (1 MB)
max_conns_per_ip: 0

# ==============================================================================
# Monitoring and Logging
# ==============================================================================

# Log violations to file (optional)
# log_file: "/var/log/nsjail-malware-sandbox.log"

# Seccomp violation log level
seccomp_log: true

# ==============================================================================
# Notes
# ==============================================================================
#
# This configuration provides:
# - Process isolation (PID namespace)
# - Filesystem isolation (mount namespace with minimal read-only mounts)
# - Network isolation (no network access)
# - User isolation (UID/GID remapping to nobody)
# - Resource limits (CPU, memory, file descriptors)
# - Syscall filtering (seccomp-bpf via Kafel DSL)
#
# Adjust resource limits and mounts based on specific analysis requirements.
# For production use, consider:
# - Reducing time_limit for faster analysis
# - Adding specific library mounts for analyzed binaries
# - Customizing seccomp policy for specific malware families
# - Logging violations to centralized security monitoring
#
