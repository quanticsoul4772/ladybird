#
# Kafel Seccomp-BPF Policy for Malware Analysis Sandbox
# Ladybird Browser - Sentinel Service
#
# This policy implements a strict syscall allowlist with logging for suspicious
# operations and blocking of dangerous syscalls. It follows a defense-in-depth
# approach with three tiers:
#
# 1. ALLOW: Safe syscalls required for basic execution
# 2. LOG: Suspicious syscalls that indicate malicious behavior
# 3. ERRNO/KILL: Dangerous syscalls that must be blocked
#
# References:
#   - https://github.com/google/kafel
#   - https://man7.org/linux/man-pages/man2/syscalls.2.html
#   - https://filippo.io/linux-syscall-table/
#
# Architecture Support:
#   - x86_64 (primary)
#   - i386 (legacy 32-bit syscalls via compat layer)
#

# ==============================================================================
# Syscall Groups (Macros)
# ==============================================================================

# File I/O operations (read-only and write)
#define FILE_IO { \
  read, \
  write, \
  pread64, \
  pwrite64, \
  readv, \
  writev, \
  preadv, \
  pwritev, \
  preadv2, \
  pwritev2 \
}

# File opening and metadata
#define FILE_OPEN { \
  open, \
  openat, \
  openat2, \
  creat \
}

#define FILE_CLOSE { \
  close, \
  close_range \
}

# File metadata (stat family)
#define FILE_STAT { \
  stat, \
  fstat, \
  lstat, \
  stat64, \
  fstat64, \
  lstat64, \
  newfstatat, \
  statx, \
  fstatat64 \
}

# File positioning
#define FILE_SEEK { \
  lseek, \
  _llseek \
}

# File operations
#define FILE_OPS { \
  dup, \
  dup2, \
  dup3, \
  fcntl, \
  fcntl64, \
  ioctl, \
  flock, \
  fsync, \
  fdatasync, \
  sync_file_range, \
  fadvise64, \
  fadvise64_64 \
}

# Directory operations
#define DIR_OPS { \
  getcwd, \
  chdir, \
  fchdir, \
  getdents, \
  getdents64, \
  readdir \
}

# Memory management (safe operations)
#define MEMORY_SAFE { \
  mmap, \
  mmap2, \
  munmap, \
  mprotect, \
  mremap, \
  brk, \
  madvise, \
  mincore, \
  msync, \
  mlock, \
  munlock, \
  mlockall, \
  munlockall \
}

# Process information (read-only)
#define PROCESS_INFO { \
  getpid, \
  getppid, \
  gettid, \
  getuid, \
  geteuid, \
  getgid, \
  getegid, \
  getresuid, \
  getresgid, \
  getgroups, \
  getpgid, \
  getpgrp, \
  getsid, \
  getuid32, \
  geteuid32, \
  getgid32, \
  getegid32, \
  getresuid32, \
  getresgid32 \
}

# Signal handling (safe operations)
#define SIGNAL_SAFE { \
  rt_sigreturn, \
  rt_sigprocmask, \
  rt_sigaction, \
  rt_sigsuspend, \
  rt_sigpending, \
  rt_sigtimedwait, \
  sigreturn, \
  sigprocmask, \
  sigaction, \
  sigsuspend, \
  sigpending, \
  alarm \
}

# Time operations
#define TIME_OPS { \
  clock_gettime, \
  clock_getres, \
  gettimeofday, \
  time, \
  nanosleep, \
  clock_nanosleep, \
  getitimer \
}

# I/O multiplexing
#define IO_MULTIPLEX { \
  select, \
  pselect6, \
  poll, \
  ppoll, \
  epoll_create, \
  epoll_create1, \
  epoll_ctl, \
  epoll_wait, \
  epoll_pwait, \
  epoll_pwait2 \
}

# File access checks
#define FILE_ACCESS { \
  access, \
  faccessat, \
  faccessat2 \
}

# Symlink operations
#define SYMLINK_OPS { \
  readlink, \
  readlinkat \
}

# Thread-local storage
#define THREAD_LOCAL { \
  set_thread_area, \
  get_thread_area, \
  set_tid_address, \
  arch_prctl \
}

# Resource limits (query only)
#define RLIMIT_QUERY { \
  getrlimit, \
  ugetrlimit, \
  prlimit64, \
  getrusage \
}

# Futex operations (for threading primitives)
#define FUTEX_OPS { \
  futex, \
  set_robust_list, \
  get_robust_list \
}

# Process exit
#define PROCESS_EXIT { \
  exit, \
  exit_group \
}

# Pipe operations
#define PIPE_OPS { \
  pipe, \
  pipe2 \
}

# Event file descriptors
#define EVENTFD_OPS { \
  eventfd, \
  eventfd2 \
}

# Timer file descriptors
#define TIMERFD_OPS { \
  timerfd_create, \
  timerfd_settime, \
  timerfd_gettime \
}

# ==============================================================================
# Network Operations (Logged, not allowed)
# ==============================================================================

#define NETWORK_OPS { \
  socket, \
  socketpair, \
  connect, \
  bind, \
  listen, \
  accept, \
  accept4, \
  sendto, \
  recvfrom, \
  sendmsg, \
  recvmsg, \
  sendmmsg, \
  recvmmsg, \
  shutdown, \
  setsockopt, \
  getsockopt, \
  getsockname, \
  getpeername \
}

# ==============================================================================
# Process Creation (Logged, not allowed)
# ==============================================================================

#define PROCESS_CREATE { \
  execve, \
  execveat, \
  fork, \
  vfork, \
  clone, \
  clone3 \
}

# ==============================================================================
# Debugging Operations (Logged, not allowed)
# ==============================================================================

#define DEBUG_OPS { \
  ptrace, \
  process_vm_readv, \
  process_vm_writev, \
  perf_event_open \
}

# ==============================================================================
# Kernel Module Operations (Blocked)
# ==============================================================================

#define KERNEL_MODULE { \
  init_module, \
  finit_module, \
  delete_module, \
  query_module \
}

# ==============================================================================
# Privilege Escalation (Blocked)
# ==============================================================================

#define PRIV_ESCALATE { \
  setuid, \
  setuid32, \
  setgid, \
  setgid32, \
  setreuid, \
  setreuid32, \
  setregid, \
  setregid32, \
  setresuid, \
  setresuid32, \
  setresgid, \
  setresgid32, \
  setfsuid, \
  setfsuid32, \
  setfsgid, \
  setfsgid32, \
  setgroups, \
  setgroups32, \
  capset, \
  capget \
}

# ==============================================================================
# Filesystem Modification (Blocked)
# ==============================================================================

#define FS_MODIFY { \
  mount, \
  umount, \
  umount2, \
  pivot_root, \
  chroot, \
  swapon, \
  swapoff \
}

# ==============================================================================
# Namespace Operations (Blocked)
# ==============================================================================

#define NAMESPACE_OPS { \
  unshare, \
  setns \
}

# ==============================================================================
# Dangerous System Calls (Blocked)
# ==============================================================================

#define DANGEROUS { \
  reboot, \
  kexec_load, \
  kexec_file_load, \
  acct, \
  settimeofday, \
  adjtimex, \
  clock_settime, \
  clock_adjtime, \
  stime, \
  ioperm, \
  iopl, \
  create_module, \
  get_kernel_syms, \
  syslog, \
  uselib, \
  _sysctl, \
  sysfs, \
  personality, \
  modify_ldt, \
  quotactl, \
  lookup_dcookie, \
  vhangup, \
  vm86, \
  vm86old, \
  kcmp \
}

# ==============================================================================
# Main Policy Definition
# ==============================================================================

POLICY malware_sandbox {

  # --------------------------------------------------------------------------
  # Tier 1: ALLOW - Safe syscalls required for basic execution
  # --------------------------------------------------------------------------

  ALLOW {
    # File operations
    FILE_IO,
    FILE_OPEN,
    FILE_CLOSE,
    FILE_STAT,
    FILE_SEEK,
    FILE_OPS,
    DIR_OPS,
    FILE_ACCESS,
    SYMLINK_OPS,

    # Memory operations
    MEMORY_SAFE,

    # Process operations
    PROCESS_INFO,
    PROCESS_EXIT,

    # Signal handling
    SIGNAL_SAFE,

    # Time operations
    TIME_OPS,

    # I/O multiplexing
    IO_MULTIPLEX,

    # Thread operations
    THREAD_LOCAL,
    FUTEX_OPS,

    # Resource queries
    RLIMIT_QUERY,

    # IPC primitives
    PIPE_OPS,
    EVENTFD_OPS,
    TIMERFD_OPS,

    # Additional safe syscalls
    uname,
    getrandom,
    sched_yield,
    sched_getaffinity,
    sched_setaffinity,
    getcpu,
    rseq,
    memfd_create
  },

  # --------------------------------------------------------------------------
  # Tier 2: LOG - Suspicious syscalls indicating potential malicious behavior
  # --------------------------------------------------------------------------

  LOG {
    # Network operations (malware phoning home)
    NETWORK_OPS,

    # Process creation (lateral movement, persistence)
    PROCESS_CREATE,

    # Debugging operations (anti-analysis)
    DEBUG_OPS,

    # Kernel module operations (rootkit installation)
    KERNEL_MODULE,

    # File system write operations (ransomware, data exfiltration)
    unlink,
    unlinkat,
    rmdir,
    rename,
    renameat,
    renameat2,
    mkdir,
    mkdirat,
    mknod,
    mknodat,
    chmod,
    fchmod,
    fchmodat,
    chown,
    fchown,
    lchown,
    fchownat,
    chown32,
    fchown32,
    lchown32,
    link,
    linkat,
    symlink,
    symlinkat,
    truncate,
    ftruncate,
    fallocate,

    # Extended attributes (hiding data)
    setxattr,
    lsetxattr,
    fsetxattr,
    getxattr,
    lgetxattr,
    fgetxattr,
    listxattr,
    llistxattr,
    flistxattr,
    removexattr,
    lremovexattr,
    fremovexattr,

    # Memory operations (code injection)
    memfd_secret,
    userfaultfd,
    remap_file_pages,

    # BPF operations (kernel exploitation)
    bpf,

    # Keylogging/monitoring
    add_key,
    request_key,
    keyctl
  },

  # --------------------------------------------------------------------------
  # Tier 3: ERRNO(EPERM) - Return permission denied
  # --------------------------------------------------------------------------

  ERRNO(1) {
    # Privilege escalation attempts
    PRIV_ESCALATE,

    # Filesystem modification
    FS_MODIFY,

    # Namespace manipulation
    NAMESPACE_OPS,

    # Process priority manipulation
    setpriority,
    nice,
    sched_setparam,
    sched_setscheduler,
    sched_setattr,

    # Timer manipulation (potential timing attacks)
    setitimer,
    timer_create,
    timer_settime,

    # Signal sending (potential DoS)
    kill,
    tkill,
    tgkill,
    rt_sigqueueinfo,
    rt_tgsigqueueinfo,
    sigqueueinfo,

    # Waiting operations that could be used for process tracking
    wait4,
    waitid,
    waitpid,

    # Resource limit manipulation
    setrlimit,

    # System call interception
    seccomp
  },

  # --------------------------------------------------------------------------
  # Tier 4: KILL - Immediately terminate on dangerous syscalls
  # --------------------------------------------------------------------------

  KILL {
    # Extremely dangerous operations
    DANGEROUS
  },

  # --------------------------------------------------------------------------
  # Default Action: KILL on unknown syscalls
  # --------------------------------------------------------------------------

  DEFAULT KILL
}

# ==============================================================================
# Alternative Policies
# ==============================================================================

# More permissive policy for specific analysis scenarios (commented out)
#
# POLICY malware_sandbox_permissive {
#   ALLOW {
#     FILE_IO, FILE_OPEN, FILE_CLOSE, FILE_STAT,
#     MEMORY_SAFE, PROCESS_INFO, PROCESS_EXIT,
#     SIGNAL_SAFE, TIME_OPS, NETWORK_OPS
#   },
#   LOG {
#     PROCESS_CREATE, DEBUG_OPS, KERNEL_MODULE
#   },
#   ERRNO(1) {
#     PRIV_ESCALATE, FS_MODIFY, NAMESPACE_OPS, DANGEROUS
#   },
#   DEFAULT LOG
# }

# Strictest policy - minimal syscalls only
#
# POLICY malware_sandbox_minimal {
#   ALLOW {
#     read, write, close, exit, exit_group,
#     mmap, munmap, brk,
#     rt_sigreturn
#   },
#   DEFAULT KILL
# }

# ==============================================================================
# Usage Notes
# ==============================================================================
#
# To use this policy with nsjail:
#
# 1. Inline in nsjail config:
#    seccomp_string: "@/path/to/malware-sandbox.kafel"
#
# 2. Compiled to BPF:
#    kafel malware-sandbox.kafel > malware-sandbox.bpf
#    seccomp_bpf: "/path/to/malware-sandbox.bpf"
#
# 3. Monitor violations:
#    - LOG actions write to kernel audit log (auditd)
#    - Check with: ausearch -m SECCOMP -ts recent
#    - Or: journalctl -k | grep SECCOMP
#
# 4. Customize for specific malware:
#    - Move syscalls between ALLOW/LOG/ERRNO/KILL based on analysis needs
#    - Create specialized policies for different malware families
#    - Use DEFAULT LOG during development, DEFAULT KILL in production
#
# 5. Performance considerations:
#    - BPF programs are evaluated for every syscall
#    - Keep ALLOW list minimal for better performance
#    - Group related syscalls together for clarity
#
