<!doctype html>
<html>
    <head>
        <title>Security Center</title>
        <link rel="stylesheet" type="text/css" href="resource://ladybird/ladybird.css" />
        <style>
            /* Phase 3 Security Page Styles */
            @media (prefers-color-scheme: light) {
                :root {
                    --card-background-color: #f9f9f9;
                    --card-header-background-color: #f0f2f5;
                    --stat-background: #ffffff;
                    --stat-border: #e0e0e0;
                }
            }

            @media (prefers-color-scheme: dark) {
                :root {
                    --card-background-color: #2c2c2c;
                    --card-header-background-color: #252525;
                    --stat-background: #333333;
                    --stat-border: #444444;
                }
            }

            body {
                max-width: 1200px;
                margin: 0 auto;
                padding: 20px;
            }

            header {
                display: flex;
                align-items: center;
                margin-bottom: 30px;
            }

            header h1 {
                font-size: 24px;
                font-weight: 500;
            }

            header img {
                height: 48px;
                margin-right: 12px;
            }

            .card {
                background-color: var(--card-background-color);
                border-radius: 8px;
                margin-bottom: 20px;
                overflow: hidden;
            }

            .card-header {
                background-color: var(--card-header-background-color);
                border-bottom: 1px solid var(--border-color);
                padding: 15px 20px;
                font-size: 16px;
                font-weight: 500;
            }

            .card-body {
                padding: 20px;
            }

            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }

            .stat-item {
                background-color: var(--stat-background);
                border: 1px solid var(--stat-border);
                border-radius: 8px;
                padding: 20px;
                text-align: center;
            }

            .stat-value {
                font-size: 36px;
                font-weight: 700;
                color: var(--violet-100);
                margin-bottom: 8px;
            }

            .stat-label {
                font-size: 14px;
                opacity: 0.8;
            }

            .empty-message {
                text-align: center;
                padding: 40px 20px;
                font-size: 14px;
                opacity: 0.7;
            }

            .hidden {
                display: none !important;
            }

            .help-box {
                background-color: rgba(59, 130, 246, 0.1);
                border: 2px solid #3b82f6;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
            }

            .help-box h3 {
                color: #3b82f6;
                margin: 0 0 12px 0;
                font-size: 18px;
                font-weight: 600;
            }

            .help-box p {
                margin: 0 0 12px 0;
                line-height: 1.6;
            }

            .help-box code {
                background-color: rgba(0, 0, 0, 0.1);
                padding: 3px 8px;
                border-radius: 4px;
                font-family: monospace;
                font-size: 13px;
            }

            .help-box ol {
                margin: 12px 0;
                padding-left: 24px;
            }

            .help-box li {
                margin: 8px 0;
                line-height: 1.6;
            }

            .help-box .note {
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid rgba(59, 130, 246, 0.3);
                font-size: 14px;
                opacity: 0.9;
            }

            .integration-notice {
                background-color: var(--violet-100);
                color: white;
                padding: 15px 20px;
                border-radius: 6px;
                margin-bottom: 20px;
            }

            .integration-notice h3 {
                margin: 0 0 8px 0;
                font-size: 16px;
            }

            .integration-notice p {
                margin: 0;
                font-size: 14px;
                opacity: 0.9;
            }

            /* System Status Styles */
            .status-indicator {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
            }

            .status-indicator .status-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
            }

            .status-connected {
                background-color: rgba(34, 197, 94, 0.1);
                color: #22c55e;
            }

            .status-connected .status-dot {
                background-color: #22c55e;
            }

            .status-disconnected {
                background-color: rgba(239, 68, 68, 0.1);
                color: #ef4444;
            }

            .status-disconnected .status-dot {
                background-color: #ef4444;
            }

            .status-unknown {
                background-color: rgba(156, 163, 175, 0.1);
                color: #9ca3af;
            }

            .status-unknown .status-dot {
                background-color: #9ca3af;
            }

            .status-info {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .status-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px solid var(--stat-border);
            }

            .status-item:last-child {
                border-bottom: none;
            }

            .status-label {
                font-weight: 500;
                font-size: 14px;
            }

            .status-value {
                font-size: 14px;
                opacity: 0.8;
            }

            /* Policy Template Styles */
            .button {
                padding: 10px 20px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                background-color: var(--violet-100);
                color: white;
                transition: opacity 0.2s;
            }

            .button:hover {
                opacity: 0.9;
            }

            .button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .button-secondary {
                background-color: var(--stat-background);
                color: inherit;
                border: 1px solid var(--stat-border);
            }

            .templates-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }

            .template-card {
                background-color: var(--stat-background);
                border: 1px solid var(--stat-border);
                border-radius: 8px;
                padding: 16px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .template-card:hover {
                border-color: var(--violet-100);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .template-card.selected {
                border-color: var(--violet-100);
                background-color: rgba(138, 80, 252, 0.05);
            }

            .template-name {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--violet-100);
            }

            .template-description {
                font-size: 13px;
                opacity: 0.8;
                line-height: 1.4;
            }

            .template-category {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 500;
                margin-top: 10px;
                background-color: rgba(138, 80, 252, 0.1);
                color: var(--violet-100);
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }

            .modal.active {
                display: flex;
            }

            .modal-content {
                background-color: var(--card-background-color);
                border-radius: 12px;
                padding: 30px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            }

            .modal-header {
                font-size: 20px;
                font-weight: 600;
                margin-bottom: 20px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            .form-label {
                display: block;
                font-size: 14px;
                font-weight: 500;
                margin-bottom: 8px;
            }

            .form-input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid var(--stat-border);
                border-radius: 6px;
                font-size: 14px;
                background-color: var(--stat-background);
                color: inherit;
                box-sizing: border-box;
            }

            .form-input:focus {
                outline: none;
                border-color: var(--violet-100);
            }

            .form-help {
                font-size: 12px;
                opacity: 0.7;
                margin-top: 4px;
            }

            .form-warning {
                background-color: rgba(245, 158, 11, 0.1);
                color: #f59e0b;
                padding: 12px;
                border-radius: 6px;
                font-size: 13px;
                margin-bottom: 20px;
            }

            .modal-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                margin-top: 25px;
            }

            .preview-section {
                background-color: var(--stat-background);
                border: 1px solid var(--stat-border);
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            }

            .preview-title {
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 10px;
            }

            .preview-policy {
                font-size: 13px;
                padding: 8px;
                background-color: var(--card-background-color);
                border-radius: 4px;
                margin-bottom: 8px;
                font-family: monospace;
            }

            /* Credential Protection Education Modal Styles (Sentinel Phase 6 Day 41) */
            .credential-education-modal-content {
                max-width: 700px;
                animation: slideIn 0.3s ease-out;
            }

            @keyframes slideIn {
                from {
                    transform: translateY(-30px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            .education-modal-body {
                font-size: 14px;
                line-height: 1.6;
            }

            .education-section {
                margin-bottom: 25px;
            }

            .education-section h3 {
                font-size: 16px;
                font-weight: 600;
                margin-bottom: 10px;
                color: var(--violet-100);
            }

            .education-section p {
                margin: 8px 0;
            }

            .education-section ul {
                margin: 10px 0;
                padding-left: 24px;
            }

            .education-section li {
                margin: 8px 0;
            }

            .education-action-box {
                border-left: 4px solid;
                padding: 12px 15px;
                margin: 12px 0;
                border-radius: 6px;
            }

            .education-action-box-safe {
                background-color: rgba(34, 197, 94, 0.1);
                border-color: #22c55e;
            }

            .education-action-box-danger {
                background-color: rgba(239, 68, 68, 0.1);
                border-color: #ef4444;
            }

            .education-action-box strong {
                display: block;
                margin-bottom: 6px;
            }

            .education-action-box p {
                margin: 0;
                font-size: 13px;
                opacity: 0.95;
            }

            .education-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid var(--stat-border);
            }

            .education-checkbox-label {
                display: flex;
                align-items: center;
                font-size: 14px;
                cursor: pointer;
                user-select: none;
            }

            .education-checkbox-label input[type="checkbox"] {
                margin-right: 8px;
                cursor: pointer;
            }

            /* Security Tips Section Styles (Sentinel Phase 6 Day 41) */
            .security-tips-section {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid var(--stat-border);
            }

            .security-tip {
                background-color: var(--stat-background);
                border-left: 3px solid var(--violet-100);
                padding: 15px 18px;
                margin-bottom: 12px;
                border-radius: 6px;
                transition: all 0.2s;
            }

            .security-tip:hover {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .security-tip strong {
                display: block;
                font-size: 14px;
                font-weight: 600;
                margin-bottom: 6px;
                color: var(--violet-100);
            }

            .security-tip p {
                margin: 0;
                font-size: 13px;
                line-height: 1.5;
                opacity: 0.9;
            }

            .security-tip-learn-more {
                margin-top: 8px;
                padding: 8px 16px;
                font-size: 13px;
            }

            /* Network Monitoring Styles (Milestone 0.4 Phase 6) */
            .badge {
                display: inline-block;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
            }

            .badge.threat-DGA {
                background-color: rgba(255, 107, 107, 0.2);
                color: #ff6b6b;
            }

            .badge.threat-Beaconing {
                background-color: rgba(255, 159, 28, 0.2);
                color: #ff9f1c;
            }

            .badge.threat-Exfiltration {
                background-color: rgba(203, 45, 111, 0.2);
                color: #cb2d6f;
            }

            .badge.threat-DNSTunneling {
                background-color: rgba(156, 39, 176, 0.2);
                color: #9c27b0;
            }

            .badge.threat-Combined {
                background-color: rgba(239, 68, 68, 0.2);
                color: #ef4444;
            }

            .badge.risk-Low {
                background-color: rgba(76, 175, 80, 0.2);
                color: #4caf50;
            }

            .badge.risk-Medium {
                background-color: rgba(255, 152, 0, 0.2);
                color: #ff9800;
            }

            .badge.risk-High {
                background-color: rgba(244, 67, 54, 0.2);
                color: #f44336;
            }

            .badge.risk-Critical {
                background-color: rgba(156, 39, 176, 0.2);
                color: #9c27b0;
            }

            .badge.policy-allow {
                background-color: rgba(76, 175, 80, 0.2);
                color: #4caf50;
            }

            .badge.policy-block {
                background-color: rgba(244, 67, 54, 0.2);
                color: #f44336;
            }

            .badge.policy-monitor {
                background-color: rgba(33, 150, 243, 0.2);
                color: #2196f3;
            }

            .status-dot.enabled {
                background-color: #22c55e;
            }

            .status-dot.disabled {
                background-color: #ef4444;
            }
        </style>
    </head>
    <body>
        <header>
            <picture>
                <source
                    srcset="resource://icons/128x128/app-browser.png"
                    media="(prefers-color-scheme: dark)"
                />
                <img src="resource://icons/128x128/app-browser-dark.png" alt="Ladybird Browser" />
            </picture>
            <h1>Security Center</h1>
        </header>


        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">Quick Actions</div>
            <div class="card-body">
                <button id="manage-quarantine-btn" class="button" onclick="openQuarantineManager()">
                    Manage Quarantine
                </button>
                <p style="margin-top: 10px; font-size: 13px; opacity: 0.8;">
                    View and manage files that have been quarantined by the security system.
                </p>
            </div>
        </div>

        <!-- Credential Protection (Sentinel Phase 6 Day 40) -->
        <div class="card">
            <div class="card-header">Credential Protection</div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-forms-monitored">0</div>
                        <div class="stat-label">Forms Monitored</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-credential-threats-blocked">0</div>
                        <div class="stat-label">Credential Theft Attempts Blocked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-trusted-forms">0</div>
                        <div class="stat-label">Trusted Form Relationships</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Recent Credential Alerts</h3>
                <div id="credential-alerts-container">
                    <table id="credential-alerts-table" class="hidden" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--stat-border);">
                                <th style="padding: 12px 8px;">Time</th>
                                <th style="padding: 12px 8px;">Type</th>
                                <th style="padding: 12px 8px;">Form Origin</th>
                                <th style="padding: 12px 8px;">Action Origin</th>
                                <th style="padding: 12px 8px;">Severity</th>
                                <th style="padding: 12px 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="credential-alerts-tbody">
                        </tbody>
                    </table>
                    <div id="credential-alerts-empty" class="empty-message">
                        No credential alerts yet. Ladybird is monitoring your forms for suspicious activity.
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Trusted Form Relationships</h3>
                <div id="trusted-forms-container">
                    <table id="trusted-forms-table" class="hidden" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--stat-border);">
                                <th style="padding: 12px 8px;">Form Origin</th>
                                <th style="padding: 12px 8px;">Action Origin</th>
                                <th style="padding: 12px 8px;">Learned On</th>
                                <th style="padding: 12px 8px;">Submission Count</th>
                                <th style="padding: 12px 8px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trusted-forms-tbody">
                        </tbody>
                    </table>
                    <div id="trusted-forms-empty" class="empty-message">
                        No trusted form relationships yet. When you trust a cross-origin form, it will appear here.
                    </div>
                </div>

                <!-- Import/Export Relationships (Milestone 0.3 Phase 4) -->
                <div style="margin-top: 20px; padding: 16px; background-color: var(--stat-background); border-radius: 8px; border: 1px solid var(--stat-border);">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Manage Relationships</h4>
                    <div style="display: flex; gap: 12px;">
                        <button class="button button-secondary" onclick="exportCredentialRelationships()">
                            Export Trusted Relationships
                        </button>
                        <button class="button button-secondary" onclick="importCredentialRelationships()">
                            Import Trusted Relationships
                        </button>
                    </div>
                    <p style="margin-top: 12px; font-size: 12px; opacity: 0.7;">
                        Export your trusted relationships to back them up or transfer to another browser. Import allows you to restore previously exported relationships.
                    </p>
                </div>

                <!-- Policy Templates (Milestone 0.3 Phase 5) -->
                <div style="margin-top: 20px; padding: 16px; background-color: var(--stat-background); border-radius: 8px; border: 1px solid var(--stat-border);">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Policy Templates</h4>
                    <p style="margin: 0 0 16px 0; font-size: 12px; opacity: 0.7;">
                        Pre-configured security policies for common scenarios. Apply templates to quickly enhance your protection.
                    </p>

                    <div id="template-list" style="display: flex; flex-direction: column; gap: 12px;">
                        <!-- Templates will be loaded here -->
                    </div>

                    <div style="display: flex; gap: 12px; margin-top: 16px;">
                        <button class="button button-secondary" onclick="exportPolicyTemplates()">
                            Export Templates
                        </button>
                        <button class="button button-secondary" onclick="importPolicyTemplates()">
                            Import Templates
                        </button>
                    </div>
                </div>

                <!-- Security Tips Section (Sentinel Phase 6 Day 41) -->
                <div class="security-tips-section">
                    <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">
                        <span style="font-size: 18px; margin-right: 8px;">💡</span>
                        Security Tips
                    </h3>

                    <div class="security-tip">
                        <strong>Verify URLs Before Entering Credentials</strong>
                        <p>Always check that the URL in the address bar matches the expected domain. Phishing sites often use similar-looking domains to trick users.</p>
                    </div>

                    <div class="security-tip">
                        <strong>Use HTTPS for Sensitive Information</strong>
                        <p>Look for the lock icon in the address bar. HTTPS encrypts your connection and protects your data from interception.</p>
                    </div>

                    <div class="security-tip">
                        <strong>Be Cautious with Cross-Origin Forms</strong>
                        <p>If Ladybird alerts you about a form sending data to a different domain, verify that this is expected behavior before proceeding.</p>
                    </div>

                    <div class="security-tip">
                        <strong>Review Trusted Relationships Regularly</strong>
                        <p>Periodically review your trusted form relationships above and revoke any that you no longer recognize or trust.</p>
                    </div>

                    <div class="security-tip">
                        <strong>Learn More About Credential Protection</strong>
                        <p>
                            <button class="button button-secondary security-tip-learn-more" onclick="showCredentialEducationModal()">
                                Learn How Protection Works
                            </button>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Monitoring (Milestone 0.4 Phase 6) -->
        <div class="card">
            <div class="card-header">Network Behavioral Analysis</div>
            <div class="card-body">
                <div class="status-indicator" id="network-monitoring-status">
                    <span class="status-dot enabled"></span>
                    <span>Network Monitoring: Enabled</span>
                </div>
                <p style="margin-top: 12px; font-size: 14px; opacity: 0.8;">
                    Monitors network traffic for suspicious patterns including DGA domains, C2 beaconing, data exfiltration, and DNS tunneling.
                </p>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-requests-monitored">0</div>
                        <div class="stat-label">Requests Monitored</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-network-alerts">0</div>
                        <div class="stat-label">Alerts Generated</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-domains-analyzed">0</div>
                        <div class="stat-label">Domains Analyzed</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Recent Traffic Alerts</h3>
                <div id="network-alerts-container">
                    <table id="network-alerts-table" class="hidden" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--stat-border);">
                                <th style="padding: 12px 8px;">Timestamp</th>
                                <th style="padding: 12px 8px;">Domain</th>
                                <th style="padding: 12px 8px;">Threat Type</th>
                                <th style="padding: 12px 8px;">Risk Level</th>
                                <th style="padding: 12px 8px;">Confidence</th>
                                <th style="padding: 12px 8px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="network-alerts-tbody">
                        </tbody>
                    </table>
                    <div id="network-alerts-empty" class="empty-message">
                        No traffic alerts yet. Ladybird is monitoring your network connections for suspicious behavior.
                    </div>
                </div>
                <button id="clear-network-alerts-btn" class="button button-secondary" style="margin-top: 12px; display: none;">
                    Clear Alert History
                </button>

                <h3 style="margin-top: 30px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">Network Behavior Policies</h3>
                <div id="network-policies-container">
                    <table id="network-policies-table" class="hidden" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="text-align: left; border-bottom: 2px solid var(--stat-border);">
                                <th style="padding: 12px 8px;">Domain</th>
                                <th style="padding: 12px 8px;">Policy</th>
                                <th style="padding: 12px 8px;">Threat Type</th>
                                <th style="padding: 12px 8px;">Created</th>
                                <th style="padding: 12px 8px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="network-policies-tbody">
                        </tbody>
                    </table>
                    <div id="network-policies-empty" class="empty-message">
                        No network behavior policies yet. Policies are created when you select "Remember this decision" in traffic alerts.
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="button button-secondary" onclick="exportNetworkPolicies()">
                        Export Policies
                    </button>
                    <button class="button button-secondary" onclick="importNetworkPolicies()">
                        Import Policies
                    </button>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card">
            <div class="card-header">System Status</div>
            <div class="card-body">
                <div class="status-info">
                    <div class="status-item">
                        <span class="status-label">SentinelServer Connection</span>
                        <span id="sentinel-connection-status" class="status-indicator status-unknown">
                            <span class="status-dot"></span>
                            <span>Checking...</span>
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Security Scanning</span>
                        <span id="scanning-status" class="status-value">Unknown</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Last Scan</span>
                        <span id="last-scan-time" class="status-value">Never</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Socket Path</span>
                        <span class="status-value">/tmp/sentinel.sock</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Box (shown when disconnected) -->
        <div id="sentinel-help-box" class="help-box hidden">
            <h3>🔧 Sentinel Security Service Status</h3>
            <p>The Sentinel daemon automatically starts when Ladybird launches. If you're seeing a disconnected status, this usually means:</p>
            <ul>
                <li><strong>First launch:</strong> Sentinel is still initializing (wait a few seconds and refresh)</li>
                <li><strong>Startup issue:</strong> Check the console output for error messages</li>
                <li><strong>Manual restart needed:</strong> If Sentinel crashed, restart Ladybird to auto-start it</li>
            </ul>
            <div class="note">
                <strong>Auto-Start:</strong> Sentinel now starts automatically - no manual terminal commands needed! The daemon runs in the background and communicates via <code>/tmp/sentinel.sock</code>.
            </div>
            <div class="note" style="border-top: none; padding-top: 8px;">
                <strong>Tip:</strong> Use the command-line tool to check status: <code>./Build/release/bin/sentinel-cli status</code>
            </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="card">
            <div class="card-header">Security Statistics</div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="stat-total-policies">0</div>
                        <div class="stat-label">Active Policies</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-threats-blocked">0</div>
                        <div class="stat-label">Threats Blocked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-threats-quarantined">0</div>
                        <div class="stat-label">Files Quarantined</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="stat-threats-today">0</div>
                        <div class="stat-label">Threats Today</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Templates Section -->
        <div class="card">
            <div class="card-header">
                Policy Templates
                <button id="create-from-template-btn" class="button" style="float: right; margin-top: -5px;">
                    Create from Template
                </button>
            </div>
            <div class="card-body">
                <p style="margin-bottom: 15px;">Use pre-configured templates to quickly create security policies for common scenarios.</p>
                <div id="templates-grid" class="templates-grid">
                    <div class="empty-message">Loading templates...</div>
                </div>
            </div>
        </div>

        <!-- Active Policies Section -->
        <div class="card">
            <div class="card-header">Active Security Policies</div>
            <div class="card-body">
                <div id="policies-empty" class="empty-message">
                    No security policies configured yet. Policies are created when you select "Remember this decision" in security alerts or by using policy templates.
                </div>
            </div>
        </div>

        <!-- Threat History Section -->
        <div class="card">
            <div class="card-header">Threat History</div>
            <div class="card-body">
                <div id="threats-empty" class="empty-message">
                    No threats detected yet. Your browser is secure.
                </div>
            </div>
        </div>

        <!-- About Security Protection -->
        <div class="card">
            <div class="card-header">About Security Protection</div>
            <div class="card-body">
                <h4>How It Works</h4>
                <p>Ladybird includes built-in malware protection that automatically scans downloads. When a threat is detected:</p>
                <ol>
                    <li>The download pauses automatically</li>
                    <li>A security alert shows the threat details</li>
                    <li>You can choose to block, quarantine, or allow the file</li>
                    <li>Select "Remember this decision" to create a policy for future downloads</li>
                    <li>Policies automatically handle similar threats without prompting</li>
                </ol>

                <h4>Security Actions</h4>
                <ul>
                    <li><strong>Block:</strong> Prevents download and removes the file</li>
                    <li><strong>Quarantine:</strong> Isolates the file in a secure location for analysis</li>
                    <li><strong>Allow:</strong> Permits the download to complete</li>
                    <li><strong>Always Allow:</strong> Creates a whitelist policy for this file</li>
                </ul>
            </div>
        </div>

        <!-- Template Creation Modal -->
        <div id="template-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">Create Policy from Template</div>
                <div id="template-modal-body">
                    <!-- Template details will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Credential Protection Education Modal (Sentinel Phase 6 Day 41) -->
        <div id="credential-education-modal" class="modal">
            <div class="modal-content credential-education-modal-content">
                <div class="modal-header">
                    <span style="font-size: 24px; margin-right: 12px;">🛡️</span>
                    Understanding Credential Protection
                </div>
                <div class="education-modal-body">
                    <p style="font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                        Ladybird actively protects your passwords and sensitive information from theft attempts. Here's what you need to know:
                    </p>

                    <div class="education-section">
                        <h3>What is Credential Exfiltration?</h3>
                        <p>
                            Credential exfiltration occurs when a malicious website tries to steal your login information by:
                        </p>
                        <ul>
                            <li>Sending your password to a different domain than expected</li>
                            <li>Using insecure connections (HTTP instead of HTTPS) for sensitive data</li>
                            <li>Embedding third-party forms that collect your credentials</li>
                            <li>Mimicking legitimate login pages to capture your information</li>
                        </ul>
                    </div>

                    <div class="education-section">
                        <h3>How Ladybird Protects You</h3>
                        <ul>
                            <li><strong>Real-time Monitoring:</strong> Every form submission is analyzed for suspicious patterns</li>
                            <li><strong>Alert System:</strong> You'll be warned before credentials are sent to unexpected destinations</li>
                            <li><strong>Autofill Protection:</strong> Password autofill is blocked on suspicious forms</li>
                            <li><strong>Trust Learning:</strong> After you approve a form once, Ladybird remembers your decision</li>
                        </ul>
                    </div>

                    <div class="education-section">
                        <h3>What to Do When Alerted</h3>
                        <div class="education-action-box education-action-box-safe">
                            <strong>If you recognize the website and trust it:</strong>
                            <p>Click "Trust This Form" to proceed. Ladybird will remember your decision and won't alert you again for this site.</p>
                        </div>
                        <div class="education-action-box education-action-box-danger">
                            <strong>If something seems suspicious:</strong>
                            <p>Click "Block" to prevent the submission. Double-check the URL and verify you're on the legitimate website.</p>
                        </div>
                    </div>

                    <div class="education-section">
                        <h3>Managing Trusted Forms</h3>
                        <p>
                            You can review and revoke trusted form relationships at any time on this Security Center page. Look for the "Trusted Form Relationships" section above.
                        </p>
                    </div>

                    <div class="education-footer">
                        <label class="education-checkbox-label">
                            <input type="checkbox" id="credential-education-dont-show">
                            Don't show this again
                        </label>
                        <button class="button" id="credential-education-close">Got It</button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module">
            // Security Page JavaScript Controller

            // Status refresh interval (30 seconds)
            const STATUS_REFRESH_INTERVAL = 30000;
            let statusRefreshTimer = null;
            let selectedTemplate = null;
            let availableTemplates = [];

            // Make openQuarantineManager available globally
            window.openQuarantineManager = function() {
                console.log("Opening Quarantine Manager...");
                ladybird.sendMessage("openQuarantineManager");
            };

            document.addEventListener("WebUILoaded", () => {
                console.log("Security UI loaded");
                loadSystemStatus();
                loadStatistics();
                loadPolicies();
                loadThreats();
                loadTemplates();
                loadCredentialProtectionData();  // NEW: Load credential protection data
                loadPolicyTemplates();  // NEW: Load policy templates (Milestone 0.3 Phase 5)

                // Start periodic status refresh
                startStatusRefresh();

                // Setup template UI
                setupTemplateUI();

                // Check URL fragment to auto-show education modal (Sentinel Phase 6 Day 41)
                if (window.location.hash === '#show-credential-education') {
                    // Show the education modal after a brief delay to ensure page is fully loaded
                    setTimeout(() => {
                        showCredentialEducationModal();
                        // Clear the hash so refreshing doesn't show it again
                        history.replaceState(null, '', window.location.pathname);
                    }, 100);
                }
            });

            document.addEventListener("WebUIMessage", event => {
                const { name, data } = event.detail;

                switch (name) {
                    case "systemStatusLoaded":
                        renderSystemStatus(data);
                        break;
                    case "statisticsLoaded":
                        renderStatistics(data);
                        break;
                    case "policiesLoaded":
                        renderPolicies(data);
                        break;
                    case "threatHistoryLoaded":
                        renderThreats(data);
                        break;
                    case "templatesLoaded":
                        renderTemplates(data);
                        break;
                    case "policyFromTemplateCreated":
                        handleTemplateCreated(data);
                        break;
                    case "credentialProtectionDataLoaded":
                        renderCredentialProtectionData(data);
                        break;
                    case "trustedFormRevoked":
                        handleTrustedFormRevoked(data);
                        break;
                    case "credentialExported":
                        handleCredentialExport(data);
                        break;
                    case "credentialImported":
                        handleCredentialImport(data);
                        break;
                    case "policyTemplates":
                        handlePolicyTemplates(data);
                        break;
                    case "templateApplied":
                        handleTemplateApplied(data);
                        break;
                    case "templateExported":
                        handleTemplateExport(data);
                        break;
                    case "templateImported":
                        handleTemplateImport(data);
                        break;
                }
            });

            function startStatusRefresh() {
                // Clear any existing timer
                if (statusRefreshTimer) {
                    clearInterval(statusRefreshTimer);
                }

                // Set up periodic refresh
                statusRefreshTimer = setInterval(() => {
                    loadSystemStatus();
                }, STATUS_REFRESH_INTERVAL);
            }

            function loadSystemStatus() {
                // Show "Checking..." state
                const connectionStatus = document.getElementById('sentinel-connection-status');
                connectionStatus.className = 'status-indicator status-unknown';
                connectionStatus.innerHTML = '<span class="status-dot"></span><span>Checking...</span>';

                ladybird.sendMessage("getSystemStatus");
            }

            function loadStatistics() {
                ladybird.sendMessage("loadStatistics");
            }

            function loadPolicies() {
                ladybird.sendMessage("loadPolicies");
            }

            function loadThreats() {
                ladybird.sendMessage("loadThreatHistory", {});
            }

            function renderSystemStatus(status) {
                const connectionStatus = document.getElementById('sentinel-connection-status');
                const scanningStatus = document.getElementById('scanning-status');
                const lastScanTime = document.getElementById('last-scan-time');
                const helpBox = document.getElementById('sentinel-help-box');

                // Update connection status
                if (status.connected) {
                    connectionStatus.className = 'status-indicator status-connected';
                    connectionStatus.innerHTML = '<span class="status-dot"></span><span>Connected</span>';
                    // Hide help box when connected
                    helpBox.classList.add('hidden');
                } else {
                    connectionStatus.className = 'status-indicator status-disconnected';
                    connectionStatus.innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
                    // Show help box when disconnected
                    helpBox.classList.remove('hidden');
                }

                // Update scanning status
                if (status.scanning_enabled) {
                    scanningStatus.textContent = 'Enabled';
                    scanningStatus.style.color = '#22c55e';
                } else {
                    scanningStatus.textContent = status.connected ? 'Disabled' : 'Unavailable';
                    scanningStatus.style.color = status.connected ? '#f59e0b' : '#ef4444';
                }

                // Update last scan time
                if (status.last_scan && status.last_scan > 0) {
                    const date = new Date(status.last_scan);
                    lastScanTime.textContent = date.toLocaleString();
                } else {
                    lastScanTime.textContent = 'Never';
                }
            }

            function renderStatistics(stats) {
                document.getElementById('stat-total-policies').textContent = stats.totalPolicies || 0;
                document.getElementById('stat-threats-blocked').textContent = stats.threatsBlocked || 0;
                document.getElementById('stat-threats-quarantined').textContent = stats.threatsQuarantined || 0;
                document.getElementById('stat-threats-today').textContent = stats.threatsToday || 0;
            }

            function renderPolicies(data) {
                if (!data.policies || data.policies.length === 0) {
                    document.getElementById('policies-empty').classList.remove('hidden');
                    return;
                }

                document.getElementById('policies-empty').classList.add('hidden');
                // TODO: Render policies table when PolicyGraph integration is complete
            }

            function renderThreats(data) {
                if (!data.threats || data.threats.length === 0) {
                    document.getElementById('threats-empty').classList.remove('hidden');
                    return;
                }

                document.getElementById('threats-empty').classList.add('hidden');
                // TODO: Render threats table when PolicyGraph integration is complete
            }

            // Template Functions

            function loadTemplates() {
                ladybird.sendMessage("getTemplates");
            }

            function setupTemplateUI() {
                const createBtn = document.getElementById('create-from-template-btn');
                const modal = document.getElementById('template-modal');

                createBtn.addEventListener('click', () => {
                    if (selectedTemplate) {
                        showTemplateModal(selectedTemplate);
                    } else {
                        alert('Please select a template first');
                    }
                });

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeTemplateModal();
                    }
                });
            }

            function renderTemplates(data) {
                const templatesGrid = document.getElementById('templates-grid');

                if (!data.templates || data.templates.length === 0) {
                    templatesGrid.innerHTML = '<div class="empty-message">No templates available</div>';
                    return;
                }

                availableTemplates = data.templates;
                templatesGrid.innerHTML = '';

                data.templates.forEach(template => {
                    const card = document.createElement('div');
                    card.className = 'template-card';
                    card.dataset.templateId = template.id;

                    card.innerHTML = `
                        <div class="template-name">${template.name}</div>
                        <div class="template-description">${template.description}</div>
                        <span class="template-category">${template.category || 'General'}</span>
                    `;

                    card.addEventListener('click', () => {
                        // Remove selection from other cards
                        document.querySelectorAll('.template-card').forEach(c => {
                            c.classList.remove('selected');
                        });

                        // Select this card
                        card.classList.add('selected');
                        selectedTemplate = template;
                    });

                    templatesGrid.appendChild(card);
                });
            }

            function showTemplateModal(template) {
                const modal = document.getElementById('template-modal');
                const modalBody = document.getElementById('template-modal-body');

                let html = '';

                // Show warning if template has one
                if (template.warning) {
                    html += `<div class="form-warning">${template.warning}</div>`;
                }

                // Template description
                html += `<p style="margin-bottom: 20px;">${template.description}</p>`;

                // Render form fields for variables
                if (template.variables && template.variables.length > 0) {
                    template.variables.forEach(variable => {
                        html += `
                            <div class="form-group">
                                <label class="form-label" for="var-${variable.name}">
                                    ${variable.label}${variable.required ? ' *' : ''}
                                </label>
                                <input
                                    type="${variable.type || 'text'}"
                                    id="var-${variable.name}"
                                    class="form-input"
                                    placeholder="${variable.placeholder || ''}"
                                    ${variable.required ? 'required' : ''}
                                    data-validation="${variable.validation || ''}"
                                />
                                ${variable.helpText ? `<div class="form-help">${variable.helpText}</div>` : ''}
                            </div>
                        `;
                    });
                }

                // Preview section
                html += `
                    <div class="preview-section">
                        <div class="preview-title">Preview</div>
                        <div id="policy-preview">
                            <em>Fill in the form to see a preview of the policies that will be created</em>
                        </div>
                    </div>
                `;

                // Modal actions
                html += `
                    <div class="modal-actions">
                        <button class="button button-secondary" onclick="closeTemplateModal()">Cancel</button>
                        <button class="button" id="create-policies-btn">Create Policies</button>
                    </div>
                `;

                modalBody.innerHTML = html;
                modal.classList.add('active');

                // Add event listeners for live preview
                if (template.variables) {
                    template.variables.forEach(variable => {
                        const input = document.getElementById(`var-${variable.name}`);
                        if (input) {
                            input.addEventListener('input', () => updatePreview(template));
                        }
                    });
                }

                // Add event listener for create button
                document.getElementById('create-policies-btn').addEventListener('click', () => {
                    createPoliciesFromTemplate(template);
                });

                // Initial preview
                updatePreview(template);
            }

            function closeTemplateModal() {
                const modal = document.getElementById('template-modal');
                modal.classList.remove('active');
            }

            // Make it available globally
            window.closeTemplateModal = closeTemplateModal;

            function updatePreview(template) {
                const previewDiv = document.getElementById('policy-preview');
                if (!previewDiv) return;

                // Collect variable values
                const variables = {};
                let allFilled = true;

                if (template.variables) {
                    template.variables.forEach(variable => {
                        const input = document.getElementById(`var-${variable.name}`);
                        if (input) {
                            variables[variable.name] = input.value;
                            if (variable.required && !input.value) {
                                allFilled = false;
                            }
                        }
                    });
                }

                if (!allFilled) {
                    previewDiv.innerHTML = '<em>Fill in all required fields to see preview</em>';
                    return;
                }

                // Generate preview
                let previewHtml = '';
                if (template.policies) {
                    template.policies.forEach((policy, index) => {
                        let ruleName = policy.ruleName;
                        let urlPattern = policy.match_pattern.url_pattern;
                        let fileHash = policy.match_pattern.file_hash;

                        // Substitute variables
                        Object.keys(variables).forEach(varName => {
                            const placeholder = '${' + varName + '}';
                            ruleName = ruleName.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), variables[varName]);
                            if (urlPattern) {
                                urlPattern = urlPattern.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), variables[varName]);
                            }
                            if (fileHash) {
                                fileHash = fileHash.replace(new RegExp(placeholder.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), variables[varName]);
                            }
                        });

                        previewHtml += `
                            <div class="preview-policy">
                                <strong>${ruleName}</strong><br>
                                Action: ${policy.action}<br>
                                ${urlPattern ? `URL: ${urlPattern}<br>` : ''}
                                ${fileHash ? `Hash: ${fileHash}<br>` : ''}
                                ${policy.match_pattern.mime_type ? `MIME: ${policy.match_pattern.mime_type}` : ''}
                            </div>
                        `;
                    });
                }

                previewDiv.innerHTML = previewHtml;
            }

            function createPoliciesFromTemplate(template) {
                // Collect variable values
                const variables = {};
                let isValid = true;

                if (template.variables) {
                    template.variables.forEach(variable => {
                        const input = document.getElementById(`var-${variable.name}`);
                        if (input) {
                            const value = input.value;

                            // Validate required fields
                            if (variable.required && !value) {
                                alert(`${variable.label} is required`);
                                isValid = false;
                                return;
                            }

                            // Validate with regex if provided
                            if (variable.validation && value) {
                                const regex = new RegExp(variable.validation);
                                if (!regex.test(value)) {
                                    alert(`${variable.label} has an invalid format`);
                                    isValid = false;
                                    return;
                                }
                            }

                            variables[variable.name] = value;
                        }
                    });
                }

                if (!isValid) return;

                // Send message to create policies
                ladybird.sendMessage("createFromTemplate", {
                    templateId: template.id,
                    variables: variables
                });

                // Disable button while processing
                const btn = document.getElementById('create-policies-btn');
                btn.disabled = true;
                btn.textContent = 'Creating...';
            }

            function handleTemplateCreated(data) {
                if (data.error) {
                    alert('Failed to create policies: ' + data.error);
                    const btn = document.getElementById('create-policies-btn');
                    if (btn) {
                        btn.disabled = false;
                        btn.textContent = 'Create Policies';
                    }
                } else {
                    alert(data.message || 'Policies created successfully!');
                    closeTemplateModal();

                    // Reload statistics and policies
                    loadStatistics();
                    loadPolicies();
                }
            }

            // Credential Protection Functions (Sentinel Phase 6 Day 40)

            function loadCredentialProtectionData() {
                ladybird.sendMessage("getCredentialProtectionData");
            }

            function renderCredentialProtectionData(data) {
                // Update stats cards
                document.getElementById('stat-forms-monitored').textContent = data.formsMonitored || 0;
                document.getElementById('stat-credential-threats-blocked').textContent = data.threatsBlocked || 0;
                document.getElementById('stat-trusted-forms').textContent = data.trustedForms || 0;

                // Render credential alerts table
                renderCredentialAlerts(data.alerts || []);

                // Render trusted forms table
                renderTrustedForms(data.trustedRelationships || []);
            }

            function renderCredentialAlerts(alerts) {
                const table = document.getElementById('credential-alerts-table');
                const tbody = document.getElementById('credential-alerts-tbody');
                const emptyMsg = document.getElementById('credential-alerts-empty');

                if (!alerts || alerts.length === 0) {
                    table.classList.add('hidden');
                    emptyMsg.classList.remove('hidden');
                    return;
                }

                table.classList.remove('hidden');
                emptyMsg.classList.add('hidden');

                tbody.innerHTML = '';

                alerts.forEach(alert => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--stat-border)';

                    // Time
                    const timeCell = document.createElement('td');
                    timeCell.style.padding = '12px 8px';
                    const date = new Date(alert.timestamp);
                    timeCell.textContent = date.toLocaleString();
                    row.appendChild(timeCell);

                    // Type
                    const typeCell = document.createElement('td');
                    typeCell.style.padding = '12px 8px';
                    typeCell.textContent = formatAlertType(alert.alertType);
                    row.appendChild(typeCell);

                    // Form Origin
                    const formOriginCell = document.createElement('td');
                    formOriginCell.style.padding = '12px 8px';
                    formOriginCell.style.fontSize = '13px';
                    formOriginCell.textContent = alert.formOrigin;
                    row.appendChild(formOriginCell);

                    // Action Origin
                    const actionOriginCell = document.createElement('td');
                    actionOriginCell.style.padding = '12px 8px';
                    actionOriginCell.style.fontSize = '13px';
                    actionOriginCell.textContent = alert.actionOrigin;
                    row.appendChild(actionOriginCell);

                    // Severity
                    const severityCell = document.createElement('td');
                    severityCell.style.padding = '12px 8px';
                    const severityBadge = document.createElement('span');
                    severityBadge.style.padding = '4px 12px';
                    severityBadge.style.borderRadius = '12px';
                    severityBadge.style.fontSize = '12px';
                    severityBadge.style.fontWeight = '600';
                    severityBadge.textContent = alert.severity || 'Unknown';

                    // Color code by severity
                    if (alert.severity === 'critical') {
                        severityBadge.style.backgroundColor = 'rgba(239, 68, 68, 0.2)';
                        severityBadge.style.color = '#ef4444';
                    } else if (alert.severity === 'high') {
                        severityBadge.style.backgroundColor = 'rgba(245, 158, 11, 0.2)';
                        severityBadge.style.color = '#f59e0b';
                    } else {
                        severityBadge.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                        severityBadge.style.color = '#3b82f6';
                    }

                    severityCell.appendChild(severityBadge);
                    row.appendChild(severityCell);

                    // Status
                    const statusCell = document.createElement('td');
                    statusCell.style.padding = '12px 8px';
                    statusCell.style.fontSize = '13px';
                    statusCell.textContent = alert.status || 'Blocked';
                    row.appendChild(statusCell);

                    tbody.appendChild(row);
                });
            }

            function renderTrustedForms(trustedForms) {
                const table = document.getElementById('trusted-forms-table');
                const tbody = document.getElementById('trusted-forms-tbody');
                const emptyMsg = document.getElementById('trusted-forms-empty');

                if (!trustedForms || trustedForms.length === 0) {
                    table.classList.add('hidden');
                    emptyMsg.classList.remove('hidden');
                    return;
                }

                table.classList.remove('hidden');
                emptyMsg.classList.add('hidden');

                tbody.innerHTML = '';

                trustedForms.forEach(trust => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--stat-border)';

                    // Form Origin
                    const formOriginCell = document.createElement('td');
                    formOriginCell.style.padding = '12px 8px';
                    formOriginCell.style.fontSize = '13px';
                    formOriginCell.textContent = trust.formOrigin;
                    row.appendChild(formOriginCell);

                    // Action Origin
                    const actionOriginCell = document.createElement('td');
                    actionOriginCell.style.padding = '12px 8px';
                    actionOriginCell.style.fontSize = '13px';
                    actionOriginCell.textContent = trust.actionOrigin;
                    row.appendChild(actionOriginCell);

                    // Learned On
                    const learnedCell = document.createElement('td');
                    learnedCell.style.padding = '12px 8px';
                    learnedCell.style.fontSize = '13px';
                    const date = new Date(trust.learnedAt);
                    learnedCell.textContent = date.toLocaleDateString();
                    row.appendChild(learnedCell);

                    // Submission Count
                    const countCell = document.createElement('td');
                    countCell.style.padding = '12px 8px';
                    countCell.textContent = trust.submissionCount || 0;
                    row.appendChild(countCell);

                    // Actions
                    const actionsCell = document.createElement('td');
                    actionsCell.style.padding = '12px 8px';

                    const revokeBtn = document.createElement('button');
                    revokeBtn.className = 'button button-secondary';
                    revokeBtn.style.padding = '6px 12px';
                    revokeBtn.style.fontSize = '13px';
                    revokeBtn.textContent = 'Revoke Trust';
                    revokeBtn.onclick = () => revokeTrustedForm(trust.formOrigin, trust.actionOrigin);

                    actionsCell.appendChild(revokeBtn);
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });
            }

            function formatAlertType(alertType) {
                const types = {
                    'insecure_credential_post': 'Insecure Credential Post',
                    'credential_exfiltration': 'Credential Exfiltration',
                    'third_party_form_post': 'Third-Party Form',
                    'form_action_mismatch': 'Form Action Mismatch'
                };
                return types[alertType] || alertType;
            }

            function revokeTrustedForm(formOrigin, actionOrigin) {
                if (!confirm(`Revoke trust for forms from "${formOrigin}" to "${actionOrigin}"?\n\nYou will be alerted again if this form attempts to submit credentials.`)) {
                    return;
                }

                ladybird.sendMessage("revokeTrustedForm", {
                    formOrigin: formOrigin,
                    actionOrigin: actionOrigin
                });
            }

            function handleTrustedFormRevoked(data) {
                if (data.error) {
                    alert('Failed to revoke trust: ' + data.error);
                } else {
                    // Reload credential protection data
                    loadCredentialProtectionData();
                }
            }

            // Make revokeTrustedForm available globally
            window.revokeTrustedForm = revokeTrustedForm;

            // Import/Export Functions (Milestone 0.3 Phase 4)

            function exportCredentialRelationships() {
                ladybird.sendMessage("exportCredentialRelationships", {});
            }

            function importCredentialRelationships() {
                // Create file input element
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const json = event.target.result;
                            // Validate it's valid JSON
                            JSON.parse(json);
                            // Send to backend
                            ladybird.sendMessage("importCredentialRelationships", { json: json });
                        } catch (error) {
                            alert('Invalid JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };

                input.click();
            }

            function handleCredentialExport(data) {
                if (data.error) {
                    alert('Failed to export relationships: ' + data.error);
                    return;
                }

                // Create a blob from the JSON data
                const blob = new Blob([data.json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // Create a temporary link and trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = `credential-relationships-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();

                // Cleanup
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('Credential relationships exported successfully!');
            }

            function handleCredentialImport(data) {
                if (data.error) {
                    alert('Failed to import relationships: ' + data.error);
                } else {
                    alert(`Successfully imported ${data.count} credential relationships!`);
                    loadCredentialProtectionData();
                }
            }

            // Make import/export functions available globally
            window.exportCredentialRelationships = exportCredentialRelationships;
            window.importCredentialRelationships = importCredentialRelationships;

            // Policy Template Functions (Milestone 0.3 Phase 5)

            function loadPolicyTemplates() {
                ladybird.sendMessage("getPolicyTemplates", {});
            }

            function handlePolicyTemplates(data) {
                if (data.error) {
                    console.error('Failed to load policy templates:', data.error);
                    return;
                }

                const templateList = document.getElementById('template-list');
                templateList.innerHTML = '';

                const templates = JSON.parse(data.templates);
                if (templates.length === 0) {
                    templateList.innerHTML = '<p style="opacity: 0.5; font-size: 12px;">No templates available</p>';
                    return;
                }

                templates.forEach(template => {
                    const templateCard = document.createElement('div');
                    templateCard.style.cssText = 'padding: 12px; background-color: var(--background); border: 1px solid var(--stat-border); border-radius: 6px;';

                    const header = document.createElement('div');
                    header.style.cssText = 'display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;';

                    const titleDiv = document.createElement('div');
                    titleDiv.style.cssText = 'flex: 1;';

                    const title = document.createElement('div');
                    title.style.cssText = 'font-weight: 600; font-size: 13px; margin-bottom: 4px;';
                    title.textContent = template.name;

                    const category = document.createElement('span');
                    category.style.cssText = 'font-size: 11px; padding: 2px 8px; background-color: var(--stat-background); border-radius: 3px; opacity: 0.8;';
                    category.textContent = template.category;

                    const description = document.createElement('p');
                    description.style.cssText = 'margin: 8px 0 0 0; font-size: 12px; opacity: 0.7; line-height: 1.4;';
                    description.textContent = template.description;

                    const applyBtn = document.createElement('button');
                    applyBtn.className = 'button button-primary';
                    applyBtn.style.cssText = 'font-size: 11px; padding: 4px 12px;';
                    applyBtn.textContent = template.is_builtin ? 'Apply' : 'Apply Custom';
                    applyBtn.onclick = () => applyPolicyTemplate(template.id, template.name);

                    titleDiv.appendChild(title);
                    titleDiv.appendChild(category);
                    header.appendChild(titleDiv);
                    header.appendChild(applyBtn);

                    templateCard.appendChild(header);
                    templateCard.appendChild(description);
                    templateList.appendChild(templateCard);
                });
            }

            function applyPolicyTemplate(templateId, templateName) {
                if (confirm(`Apply policy template "${templateName}"?\n\nThis will create new security policies based on this template.`)) {
                    ladybird.sendMessage("applyPolicyTemplate", { template_id: templateId });
                }
            }

            function handleTemplateApplied(data) {
                if (data.error) {
                    alert('Failed to apply template: ' + data.error);
                } else {
                    alert(`Policy template applied successfully!\n\nCreated ${data.policies_created} new policies.`);
                }
            }

            function exportPolicyTemplates() {
                ladybird.sendMessage("exportPolicyTemplates", {});
            }

            function importPolicyTemplates() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const json = event.target.result;
                            JSON.parse(json); // Validate
                            ladybird.sendMessage("importPolicyTemplates", { json: json });
                        } catch (error) {
                            alert('Invalid JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };

                input.click();
            }

            function handleTemplateExport(data) {
                if (data.error) {
                    alert('Failed to export templates: ' + data.error);
                    return;
                }

                const blob = new Blob([data.json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `policy-templates-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('Policy templates exported successfully!');
            }

            function handleTemplateImport(data) {
                if (data.error) {
                    alert('Failed to import templates: ' + data.error);
                } else {
                    alert(`Successfully imported ${data.count} policy templates!`);
                    loadPolicyTemplates();
                }
            }

            // Make template functions available globally
            window.exportPolicyTemplates = exportPolicyTemplates;
            window.importPolicyTemplates = importPolicyTemplates;

            // Credential Protection Education Modal Functions (Sentinel Phase 6 Day 41)

            function showCredentialEducationModal() {
                const modal = document.getElementById('credential-education-modal');
                modal.classList.add('active');
            }

            function closeCredentialEducationModal() {
                const modal = document.getElementById('credential-education-modal');
                const dontShowCheckbox = document.getElementById('credential-education-dont-show');

                // If "Don't show again" is checked, save preference
                if (dontShowCheckbox.checked) {
                    ladybird.sendMessage("setCredentialEducationShown", { dontShowAgain: true });
                }

                modal.classList.remove('active');
            }

            // Setup education modal event handlers
            document.addEventListener("WebUILoaded", () => {
                const closeBtn = document.getElementById('credential-education-close');
                const modal = document.getElementById('credential-education-modal');

                closeBtn.addEventListener('click', closeCredentialEducationModal);

                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeCredentialEducationModal();
                    }
                });
            });

            // Make education modal functions available globally
            window.showCredentialEducationModal = showCredentialEducationModal;
            window.closeCredentialEducationModal = closeCredentialEducationModal;

            // Network Monitoring Functions (Milestone 0.4 Phase 6)

            function loadNetworkMonitoringData() {
                ladybird.sendMessage("getNetworkMonitoringStats", {});
                ladybird.sendMessage("getTrafficAlerts", {});
                ladybird.sendMessage("getNetworkBehaviorPolicies", {});
            }

            function renderNetworkMonitoringStats(data) {
                document.getElementById('stat-requests-monitored').textContent = data.requestsMonitored || 0;
                document.getElementById('stat-network-alerts').textContent = data.alertsGenerated || 0;
                document.getElementById('stat-domains-analyzed').textContent = data.domainsAnalyzed || 0;
            }

            function renderTrafficAlerts(data) {
                const table = document.getElementById('network-alerts-table');
                const tbody = document.getElementById('network-alerts-tbody');
                const emptyMsg = document.getElementById('network-alerts-empty');
                const clearBtn = document.getElementById('clear-network-alerts-btn');

                if (!data.alerts || data.alerts.length === 0) {
                    table.classList.add('hidden');
                    emptyMsg.classList.remove('hidden');
                    clearBtn.style.display = 'none';
                    return;
                }

                table.classList.remove('hidden');
                emptyMsg.classList.add('hidden');
                clearBtn.style.display = 'inline-block';

                tbody.innerHTML = '';

                data.alerts.forEach(alert => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--stat-border)';

                    // Timestamp
                    const timeCell = document.createElement('td');
                    timeCell.style.padding = '12px 8px';
                    timeCell.style.fontSize = '13px';
                    const date = new Date(alert.timestamp);
                    timeCell.textContent = date.toLocaleString();
                    row.appendChild(timeCell);

                    // Domain
                    const domainCell = document.createElement('td');
                    domainCell.style.padding = '12px 8px';
                    domainCell.style.fontSize = '13px';
                    domainCell.style.fontFamily = 'monospace';
                    domainCell.textContent = alert.domain;
                    row.appendChild(domainCell);

                    // Threat Type
                    const typeCell = document.createElement('td');
                    typeCell.style.padding = '12px 8px';
                    const typeBadge = document.createElement('span');
                    typeBadge.className = `badge threat-${alert.threatType}`;
                    typeBadge.textContent = formatThreatType(alert.threatType);
                    typeCell.appendChild(typeBadge);
                    row.appendChild(typeCell);

                    // Risk Level
                    const riskCell = document.createElement('td');
                    riskCell.style.padding = '12px 8px';
                    const riskBadge = document.createElement('span');
                    riskBadge.className = `badge risk-${alert.riskLevel}`;
                    riskBadge.textContent = alert.riskLevel;
                    riskCell.appendChild(riskBadge);
                    row.appendChild(riskCell);

                    // Confidence
                    const confidenceCell = document.createElement('td');
                    confidenceCell.style.padding = '12px 8px';
                    confidenceCell.style.fontSize = '13px';
                    confidenceCell.textContent = `${Math.round(alert.confidence * 100)}%`;
                    row.appendChild(confidenceCell);

                    // Action
                    const actionCell = document.createElement('td');
                    actionCell.style.padding = '12px 8px';
                    actionCell.style.fontSize = '13px';
                    actionCell.textContent = alert.action || 'Monitored';
                    row.appendChild(actionCell);

                    tbody.appendChild(row);
                });
            }

            function renderNetworkBehaviorPolicies(data) {
                const table = document.getElementById('network-policies-table');
                const tbody = document.getElementById('network-policies-tbody');
                const emptyMsg = document.getElementById('network-policies-empty');

                if (!data.policies || data.policies.length === 0) {
                    table.classList.add('hidden');
                    emptyMsg.classList.remove('hidden');
                    return;
                }

                table.classList.remove('hidden');
                emptyMsg.classList.add('hidden');

                tbody.innerHTML = '';

                data.policies.forEach(policy => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--stat-border)';

                    // Domain
                    const domainCell = document.createElement('td');
                    domainCell.style.padding = '12px 8px';
                    domainCell.style.fontSize = '13px';
                    domainCell.style.fontFamily = 'monospace';
                    domainCell.textContent = policy.domain;
                    row.appendChild(domainCell);

                    // Policy
                    const policyCell = document.createElement('td');
                    policyCell.style.padding = '12px 8px';
                    const policyBadge = document.createElement('span');
                    policyBadge.className = `badge policy-${policy.policy}`;
                    policyBadge.textContent = policy.policy.charAt(0).toUpperCase() + policy.policy.slice(1);
                    policyCell.appendChild(policyBadge);
                    row.appendChild(policyCell);

                    // Threat Type
                    const typeCell = document.createElement('td');
                    typeCell.style.padding = '12px 8px';
                    typeCell.style.fontSize = '13px';
                    typeCell.textContent = formatThreatType(policy.threatType);
                    row.appendChild(typeCell);

                    // Created
                    const createdCell = document.createElement('td');
                    createdCell.style.padding = '12px 8px';
                    createdCell.style.fontSize = '13px';
                    const date = new Date(policy.createdAt);
                    createdCell.textContent = date.toLocaleDateString();
                    row.appendChild(createdCell);

                    // Actions
                    const actionsCell = document.createElement('td');
                    actionsCell.style.padding = '12px 8px';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'button button-secondary';
                    deleteBtn.style.padding = '6px 12px';
                    deleteBtn.style.fontSize = '13px';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.onclick = () => deleteNetworkBehaviorPolicy(policy.id, policy.domain);

                    actionsCell.appendChild(deleteBtn);
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });
            }

            function formatThreatType(threatType) {
                const types = {
                    'DGA': 'DGA Domain',
                    'Beaconing': 'C2 Beaconing',
                    'Exfiltration': 'Data Exfiltration',
                    'DNSTunneling': 'DNS Tunneling',
                    'Combined': 'Multiple Threats',
                    'dga': 'DGA Domain',
                    'c2_beaconing': 'C2 Beaconing',
                    'exfiltration': 'Data Exfiltration',
                    'dns_tunneling': 'DNS Tunneling'
                };
                return types[threatType] || threatType;
            }

            function deleteNetworkBehaviorPolicy(policyId, domain) {
                if (!confirm(`Delete network behavior policy for "${domain}"?\n\nThis domain will be monitored again with default behavior.`)) {
                    return;
                }

                ladybird.sendMessage("deleteNetworkBehaviorPolicy", {
                    policyId: policyId
                });
            }

            function clearNetworkAlerts() {
                if (!confirm('Clear all traffic alert history?\n\nThis action cannot be undone.')) {
                    return;
                }

                ladybird.sendMessage("clearTrafficAlerts", {});
            }

            function exportNetworkPolicies() {
                ladybird.sendMessage("exportNetworkBehaviorPolicies", {});
            }

            function importNetworkPolicies() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';

                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const json = event.target.result;
                            JSON.parse(json); // Validate
                            ladybird.sendMessage("importNetworkBehaviorPolicies", { json: json });
                        } catch (error) {
                            alert('Invalid JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                };

                input.click();
            }

            // Make network monitoring functions available globally
            window.deleteNetworkBehaviorPolicy = deleteNetworkBehaviorPolicy;
            window.clearNetworkAlerts = clearNetworkAlerts;
            window.exportNetworkPolicies = exportNetworkPolicies;
            window.importNetworkPolicies = importNetworkPolicies;

            // Add event listeners for network monitoring
            document.addEventListener("WebUILoaded", () => {
                loadNetworkMonitoringData();

                // Setup clear alerts button
                const clearAlertsBtn = document.getElementById('clear-network-alerts-btn');
                if (clearAlertsBtn) {
                    clearAlertsBtn.addEventListener('click', clearNetworkAlerts);
                }

                // Refresh network monitoring data every 10 seconds
                setInterval(() => {
                    loadNetworkMonitoringData();
                }, 10000);
            });

            // Handle network monitoring message responses
            document.addEventListener("WebUIMessage", event => {
                const { name, data } = event.detail;

                if (name === "networkMonitoringStatsLoaded") {
                    renderNetworkMonitoringStats(data);
                } else if (name === "trafficAlertsLoaded") {
                    renderTrafficAlerts(data);
                } else if (name === "networkBehaviorPoliciesLoaded") {
                    renderNetworkBehaviorPolicies(data);
                } else if (name === "networkBehaviorPolicyDeleted") {
                    if (data.error) {
                        alert('Failed to delete policy: ' + data.error);
                    } else {
                        loadNetworkMonitoringData();
                    }
                } else if (name === "trafficAlertsCleared") {
                    if (data.error) {
                        alert('Failed to clear alerts: ' + data.error);
                    } else {
                        loadNetworkMonitoringData();
                    }
                } else if (name === "networkPoliciesExported") {
                    if (data.error) {
                        alert('Failed to export policies: ' + data.error);
                    } else {
                        const blob = new Blob([data.json], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `network-policies-${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        alert('Network policies exported successfully!');
                    }
                } else if (name === "networkPoliciesImported") {
                    if (data.error) {
                        alert('Failed to import policies: ' + data.error);
                    } else {
                        alert(`Successfully imported ${data.count} network behavior policies!`);
                        loadNetworkMonitoringData();
                    }
                }
            });
        </script>
    </body>
</html>
