# Malware Detection Testing Guide

Comprehensive guide for testing Ladybird's YARA-based malware detection with ML enhancement.

## Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [Test Suite (MAL-001 to MAL-010)](#test-suite)
4. [Setup and Installation](#setup-and-installation)
5. [Running Tests](#running-tests)
6. [Test Files and Fixtures](#test-files-and-fixtures)
7. [YARA Rules](#yara-rules)
8. [Integration with Sentinel](#integration-with-sentinel)
9. [Troubleshooting](#troubleshooting)
10. [Advanced Topics](#advanced-topics)

---

## Overview

### Purpose

This test suite validates Ladybird's malware detection system, which consists of:

- **SecurityTap**: Download scanning module in RequestServer
- **Sentinel Service**: Standalone daemon providing YARA + ML detection
- **MalwareMLDetector**: TensorFlow Lite-based zero-day malware detection
- **PolicyGraph**: SQLite database storing scan results and user decisions
- **YARAScanWorkerPool**: Async worker threads for parallel scanning

### Security Critical

These tests verify protection against:
- Known malware (YARA signature matching)
- Zero-day threats (ML-based heuristics)
- Packed/encrypted malware (entropy analysis)
- Credential stealers, ransomware, miners
- Drive-by downloads and exploit kits

---

## Architecture

```
Browser (Ladybird)
│
├── UI Process
│   └── Download Request
│       │
│       ▼
├── RequestServer Process
│   ├── HTTP Download
│   ├── SecurityTap.inspect_download()
│   │   ├── Size-based scanning:
│   │   │   ├── Small (<5MB): Full scan
│   │   │   ├── Medium (5-50MB): Streaming chunks
│   │   │   ├── Large (50-100MB): Partial scan
│   │   │   └── Oversized (>100MB): Skip scan
│   │   │
│   │   └── Send to Sentinel via Unix socket
│       │
│       ▼
├── Sentinel Service (standalone daemon)
│   ├── YARA Scanner
│   │   ├── Load rules from /etc/sentinel/rules/
│   │   ├── Compile rules
│   │   └── Match signatures
│   │
│   ├── MalwareMLDetector (TensorFlow Lite)
│   │   ├── Extract features (entropy, PE, strings, etc.)
│   │   ├── Neural network inference
│   │   └── Predict malware_probability
│   │
│   └── Return result (clean or threat JSON)
│       │
│       ▼
├── SecurityTap (RequestServer)
│   ├── Parse result
│   ├── If threat:
│   │   ├── Send alert to UI (page_did_request_alert)
│   │   ├── Block download OR
│   │   ├── Quarantine file (/tmp/sentinel_quarantine/)
│   │   └── Store in PolicyGraph
│   │
│   └── If clean:
│       └── Allow download
│
└── PolicyGraph (SQLite database)
    ├── scan_results table
    │   ├── sha256 (hash of file)
    │   ├── verdict (clean/malware/quarantined/blocked/allowed)
    │   ├── yara_rules_matched
    │   ├── ml_probability
    │   └── timestamp
    │
    └── Used for caching scan results (performance)
```

---

## Test Suite

### MAL-001: Known Malware Signature Detection (YARA)

**Objective**: Verify EICAR test file is detected and blocked.

**Test Flow**:
1. Download `eicar.txt` containing EICAR test string
2. SecurityTap sends content to Sentinel
3. Sentinel YARA scanner matches `EICAR_Test_File` rule
4. Alert shown to user
5. Download blocked

**Expected Result**:
- `ScanResult.is_threat = true`
- `rule_name = "EICAR_Test_File"`
- Download prevented

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-001"
```

---

### MAL-002: Clean File Scan (No False Positives)

**Objective**: Verify legitimate files pass scan without alerts.

**Test Flow**:
1. Download `clean-file.txt` with normal text content
2. SecurityTap scans file
3. Sentinel finds no YARA matches, low ML probability
4. Returns `{ result: "clean" }`
5. Download proceeds normally

**Expected Result**:
- `ScanResult.is_threat = false`
- No alert shown
- Download completes

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-002"
```

---

### MAL-003: Quarantine System

**Objective**: Verify malware is isolated to quarantine directory.

**Test Flow**:
1. Download malware file
2. User chooses "Quarantine" in security alert
3. File moved to `/tmp/sentinel_quarantine/`
4. PolicyGraph updated with `verdict="quarantined"`
5. Original download location empty

**Expected Result**:
- File exists in quarantine directory
- PolicyGraph entry created
- Download blocked from original location

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-003"
```

---

### MAL-004: User Decision Handling

**Objective**: Verify user choices are persisted in PolicyGraph.

**Test Flow**:
1. Malware detected
2. Alert shown with options: Allow, Block, Quarantine
3. User selects "Block"
4. PolicyGraph.create_scan_result() called
5. Future downloads of same file hash auto-blocked

**Expected Result**:
- Database entry: `{ sha256, verdict: "blocked_by_user" }`
- Subsequent downloads blocked without alert
- Cache hit on PolicyGraph query

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-004"
```

---

### MAL-005: ML-Based Detection (TensorFlow Lite)

**Objective**: Detect zero-day malware using ML heuristics.

**Test Flow**:
1. Download `ml-suspicious.bin` (high entropy, suspicious APIs, PE anomalies)
2. YARA scanner finds no matches (no known signature)
3. MalwareMLDetector extracts features:
   - Entropy: 7.8+ (high)
   - PE anomalies: 30+
   - Suspicious strings: 120+
   - Code ratio: < 0.2
4. ML model predicts `malware_probability = 0.87`
5. Alert shown: "ML-based detection"

**Expected Result**:
- `malware_probability > 0.5`
- `confidence > 0.8`
- Explanation includes entropy, PE anomalies, suspicious strings

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-005"
```

---

### MAL-006: Custom YARA Rules

**Objective**: Verify custom YARA rules are loaded and matched.

**Test Flow**:
1. Admin adds `custom.yar` to `/etc/sentinel/rules/`
2. Restart Sentinel or send SIGHUP to reload
3. Download `custom-test.txt` with matching signature
4. Custom rule `Detect_Test_String` matches
5. Alert shows custom rule name

**Expected Result**:
- Custom rule loaded (check Sentinel logs)
- File matches custom rule
- Alert references custom rule name

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-006"
```

---

### MAL-007: Large File Scanning

**Objective**: Test size-based scanning strategies and performance.

**Test Files**:
- Small (2MB): Full scan
- Medium (20MB): Streaming chunks
- Large (60MB): Partial scan (first + last portions)
- Oversized (120MB): Skip scan (if max_scan_size=100MB)

**Expected Result**:
- All files scanned appropriately
- No timeouts
- Telemetry: `scans_small=1, scans_medium=1, scans_large_partial=1, scans_oversized_skipped=1`
- Peak memory < 10MB

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-007"
```

---

### MAL-008: Multiple Simultaneous Downloads

**Objective**: Verify concurrent malware detection with worker pool.

**Test Flow**:
1. Download 3 files simultaneously:
   - File 1: EICAR (malware)
   - File 2: Clean
   - File 3: Clean
2. YARAScanWorkerPool processes in parallel (4 worker threads)
3. Correct verdict for each file

**Expected Result**:
- File 1 blocked (malware)
- File 2, 3 allowed (clean)
- No race conditions
- WorkerPoolTelemetry: `total_scans_completed=3, total_scans_failed=0`

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-008"
```

---

### MAL-009: Scan Result Persistence

**Objective**: Verify scan results are cached in PolicyGraph.

**Test Flow**:
1. First download of `clean-file.txt`:
   - SHA256 computed
   - PolicyGraph query returns None
   - Full scan performed (~500ms)
   - Result stored in database
2. Second download of same file:
   - SHA256 computed (same hash)
   - PolicyGraph query returns cached result
   - Scan skipped (~10ms)

**Expected Result**:
- First download: full scan
- Second download: cache hit
- 98% performance improvement

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-009"
```

---

### MAL-010: Edge Cases and Graceful Degradation

**Objective**: Ensure malware detection handles failures gracefully.

**Test Cases**:

1. **Empty File (0 bytes)**:
   - Expected: Allow download (no threat in empty file)
   - Behavior: Early return, no scan

2. **Corrupt/Truncated File**:
   - Expected: Fail-open, allow download
   - Behavior: Log error, don't block

3. **Encrypted Archive** (password-protected):
   - High entropy (looks like malware to ML)
   - Expected: Low-confidence alert, user decision
   - Behavior: Alert with "cannot scan encrypted content"

4. **Sentinel Service Unavailable**:
   - Unix socket not found
   - Expected: FAIL-OPEN, allow downloads
   - Behavior: Log warning, continue without scanning

5. **YARA Rules Compilation Error**:
   - Syntax error in custom rule
   - Expected: Disable YARA, use ML only
   - Behavior: Log error, fall back to ML

6. **ML Model Not Available**:
   - TensorFlow Lite not installed
   - Expected: Use YARA-only detection
   - Behavior: MalwareMLDetector.create() fails gracefully

7. **Network Timeout**:
   - Extremely slow download
   - Expected: Fail-open after timeout
   - Behavior: Allow download, log timeout

**Run**:
```bash
npx playwright test malware-detection.spec.ts -g "MAL-010"
```

---

## Setup and Installation

### Prerequisites

1. **Ladybird Browser** (built from source)
2. **Sentinel Service** (running)
3. **Node.js** (v18+)
4. **Playwright** (installed)

### Install Dependencies

```bash
cd Tests/Playwright
npm install
```

### Start Sentinel Service

```bash
# Build Sentinel
cmake --preset Release
cmake --build Build/release --target Sentinel

# Run Sentinel daemon
./Build/release/bin/Sentinel

# Or install as systemd service (recommended)
sudo systemctl start sentinel
```

### Install YARA Rules

```bash
# Copy test rules to Sentinel directory
sudo mkdir -p /etc/sentinel/rules
sudo cp fixtures/yara/test-rules.yar /etc/sentinel/rules/

# Reload Sentinel to load new rules
sudo killall -HUP sentinel
# OR
sudo systemctl reload sentinel

# Verify rules loaded
sudo journalctl -u sentinel | grep "Loaded.*YARA rules"
```

---

## Running Tests

### Run All Malware Tests

```bash
npx playwright test tests/security/malware-detection.spec.ts
```

### Run Specific Test

```bash
npx playwright test malware-detection.spec.ts -g "MAL-001"
```

### Run with Ladybird Browser

```bash
npx playwright test malware-detection.spec.ts --project=ladybird
```

### Run with Chromium (Reference)

```bash
npx playwright test malware-detection.spec.ts --project=chromium-reference
```

### Debug Mode

```bash
npx playwright test malware-detection.spec.ts --debug
```

### Headed Mode (Watch Browser)

```bash
npx playwright test malware-detection.spec.ts --headed
```

### Generate Report

```bash
npx playwright test malware-detection.spec.ts --reporter=html
npx playwright show-report
```

---

## Test Files and Fixtures

### Directory Structure

```
fixtures/
├── malware/
│   ├── eicar.txt                # EICAR test file (safe)
│   ├── clean-file.txt           # Legitimate text file
│   ├── clean-file2.txt          # Another clean file
│   ├── custom-test.txt          # Custom YARA rule test
│   └── ml-suspicious.bin        # ML detection test (high entropy, PE, APIs)
│
└── yara/
    ├── test-rules.yar           # YARA test rules
    └── README.md                # YARA rules documentation
```

### EICAR Test File

**Content**: `X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*`

**Purpose**: Industry-standard antivirus test file, recognized by all major AV vendors.

**Safety**: Completely safe, no actual malware code. Designed specifically for testing.

**Reference**: https://www.eicar.org/download-anti-malware-testfile/

### ML Suspicious Binary

**Features**:
- PE header (Windows executable marker)
- High entropy (7.8+) - simulates encryption/packing
- Suspicious API calls: `VirtualAlloc`, `CreateRemoteThread`, `WriteProcessMemory`
- Embedded URLs: `http://192.168.1.100/payload.exe`
- PowerShell obfuscated command
- Low code ratio (< 0.2)

**Expected ML Score**: > 0.85 malware probability

---

## YARA Rules

### Test Rules Overview

Located in `fixtures/yara/test-rules.yar`:

| Rule Name | Purpose | Matches |
|-----------|---------|---------|
| `EICAR_Test_File` | EICAR signature | `eicar.txt` |
| `Detect_Test_String` | Custom test | `custom-test.txt` |
| `PE_Suspicious_APIs` | Windows malware | `ml-suspicious.bin` |
| `Embedded_URLs` | C2 servers | `ml-suspicious.bin` |
| `Suspicious_PowerShell` | PS attacks | `ml-suspicious.bin` |
| `High_Entropy_Packed` | Packers | (future) |
| `Shellcode_Patterns` | Exploits | (future) |
| `Bitcoin_Miner_Strings` | Miners | (future) |
| `Ransomware_Indicators` | Ransomware | (future) |

### Testing YARA Rules Manually

```bash
# Test rule against file
yara fixtures/yara/test-rules.yar fixtures/malware/eicar.txt

# Expected output:
# EICAR_Test_File fixtures/malware/eicar.txt

# Show matching strings
yara -s fixtures/yara/test-rules.yar fixtures/malware/eicar.txt

# Warnings only (verify no syntax errors)
yara -w fixtures/yara/test-rules.yar fixtures/malware/eicar.txt
```

### Adding Custom Rules

1. Create `.yar` file in `fixtures/yara/`
2. Follow YARA syntax (see `test-rules.yar` for examples)
3. Test locally:
   ```bash
   yara your-rule.yar test-file.bin
   ```
4. Copy to Sentinel:
   ```bash
   sudo cp your-rule.yar /etc/sentinel/rules/
   sudo systemctl reload sentinel
   ```

---

## Integration with Sentinel

### Sentinel Service Architecture

```
Sentinel Service (/tmp/sentinel.sock)
│
├── Unix Socket Server
│   └── Listens for scan requests from SecurityTap
│
├── YARA Scanner
│   ├── Load rules from /etc/sentinel/rules/*.yar
│   ├── Compile to bytecode
│   └── Scan file content
│
├── MalwareMLDetector
│   ├── Load TensorFlow Lite model
│   ├── Extract features (entropy, PE, strings, etc.)
│   └── Neural network inference
│
└── PolicyGraph
    ├── SQLite database (/var/lib/sentinel/policies.db)
    ├── scan_results table
    └── Cache scan results by SHA256 hash
```

### Sentinel Communication Protocol

**Request Format** (JSON Lines):
```json
{
  "action": "scan_content",
  "request_id": "download_abc123...",
  "content": "BASE64_ENCODED_FILE_CONTENT"
}
```

**Response Format**:

**Clean File**:
```json
{
  "status": "success",
  "result": "clean"
}
```

**Threat Detected (YARA)**:
```json
{
  "status": "success",
  "result": "{
    \"threat_detected\": true,
    \"rule_name\": \"EICAR_Test_File\",
    \"severity\": \"high\",
    \"description\": \"EICAR test file\",
    \"recommendation\": \"Block or quarantine\"
  }"
}
```

**Threat Detected (ML)**:
```json
{
  "status": "success",
  "result": "{
    \"threat_detected\": true,
    \"detection_type\": \"ml_based\",
    \"malware_probability\": 0.87,
    \"confidence\": 0.92,
    \"explanation\": \"High entropy (7.80); PE anomalies; Suspicious APIs\",
    \"severity\": \"high\"
  }"
}
```

**Error**:
```json
{
  "status": "error",
  "error": "YARA compilation failed: syntax error"
}
```

### Checking Sentinel Status

```bash
# Check if Sentinel is running
ps aux | grep sentinel
pgrep -fa sentinel

# Check Unix socket exists
ls -la /tmp/sentinel.sock

# Check Sentinel logs
sudo journalctl -u sentinel -f

# Test connection
echo '{"action":"ping"}' | nc -U /tmp/sentinel.sock
```

---

## Troubleshooting

### Tests Failing: Sentinel Not Running

**Error**: `SecurityTap: Failed to connect to /tmp/sentinel.sock`

**Solution**:
```bash
# Start Sentinel
./Build/release/bin/Sentinel

# Or systemd
sudo systemctl start sentinel
sudo systemctl status sentinel
```

### YARA Rules Not Loading

**Error**: `Sentinel logs: "YARA compilation failed"`

**Check**:
```bash
# Verify rule syntax
yara -w fixtures/yara/test-rules.yar

# Check Sentinel rules directory
ls -la /etc/sentinel/rules/

# Ensure Sentinel has read permissions
sudo chmod 644 /etc/sentinel/rules/*.yar
```

### ML Model Not Available

**Error**: `TensorFlow Lite model not found`

**Solution**:
```bash
# Rebuild with TensorFlow Lite support
cmake --preset Release -DENABLE_TFLITE=ON
cmake --build Build/release

# Or use ML stub (fallback)
cmake --preset Release -DUSE_ML_STUB=ON
cmake --build Build/release
```

### Downloads Not Triggering Scans

**Possible Causes**:
1. SecurityTap not initialized in RequestServer
2. Sentinel unavailable (fail-open behavior)
3. File size exceeds `max_scan_size`

**Debug**:
```bash
# Enable debug logging
WEBCONTENT_DEBUG=1 REQUESTSERVER_DEBUG=1 ./Build/release/bin/Ladybird

# Check SecurityTap logs
# Should see: "SecurityTap: Connected to Sentinel daemon"
```

### Performance Issues

**Symptoms**: Scans taking >5 seconds

**Solutions**:
1. Reduce `max_scan_size` for large files
2. Increase worker pool threads (default: 4)
3. Use streaming scan for medium files
4. Cache scan results in PolicyGraph

**Configuration** (in `SecurityTap.cpp`):
```cpp
m_scan_size_config.small_file_threshold = 5 * 1024 * 1024;    // 5MB
m_scan_size_config.medium_file_threshold = 50 * 1024 * 1024;  // 50MB
m_scan_size_config.max_scan_size = 100 * 1024 * 1024;         // 100MB
```

---

## Advanced Topics

### Creating Large Test Files

```bash
# Generate 20MB file
dd if=/dev/urandom of=fixtures/malware/medium-20mb.bin bs=1M count=20

# Generate 60MB file
dd if=/dev/urandom of=fixtures/malware/large-60mb.bin bs=1M count=60

# Or use helper function
node -e "
const { generateLargeFile } = require('./tests/security/helpers/malware-test-helpers.ts');
generateLargeFile('fixtures/malware/large-60mb.bin', 60);
"
```

### PolicyGraph Database Queries

```bash
# Location
/var/lib/sentinel/policies.db

# Query scan results
sqlite3 /var/lib/sentinel/policies.db "SELECT * FROM scan_results LIMIT 10;"

# Find malware detections
sqlite3 /var/lib/sentinel/policies.db "SELECT * FROM scan_results WHERE verdict='malware';"

# Cache statistics
sqlite3 /var/lib/sentinel/policies.db "SELECT COUNT(*) FROM scan_results;"

# Clear cache (for testing)
sqlite3 /var/lib/sentinel/policies.db "DELETE FROM scan_results;"
```

### Worker Pool Telemetry

```bash
# Enable telemetry
m_scan_size_config.enable_telemetry = true;

# Check telemetry
auto telemetry = security_tap->get_worker_pool_telemetry();
dbgln("Total scans: {}", telemetry->total_scans_completed);
dbgln("Avg scan time: {}ms", telemetry->avg_scan_time_ms);
dbgln("Active workers: {}", telemetry->active_workers);
```

### Adding New ML Features

To add a new feature to ML detection:

1. Update `MalwareMLDetector::Features` struct
2. Add feature extraction in `extract_features()`
3. Normalize feature in `Features::to_vector()`
4. Retrain ML model with new feature
5. Update test expectations

Example:
```cpp
struct Features {
    // Existing features
    size_t file_size;
    float entropy;

    // NEW: Add certificate validation
    bool has_valid_certificate;

    Vector<float> to_vector() const {
        // Add to feature vector
        vec.append(has_valid_certificate ? 1.0f : 0.0f);
    }
};
```

---

## Resources

- [EICAR Test File](https://www.eicar.org/download-anti-malware-testfile/)
- [YARA Documentation](https://yara.readthedocs.io/)
- [TensorFlow Lite](https://www.tensorflow.org/lite)
- [Sentinel Architecture](../../../../docs/SENTINEL_ARCHITECTURE.md)
- [Malware Detection Guide](../../../../docs/FEATURES.md#malware-detection)

---

## License

These test files and rules are provided for educational and testing purposes only.
Use at your own risk. Not for production malware detection without proper validation.
