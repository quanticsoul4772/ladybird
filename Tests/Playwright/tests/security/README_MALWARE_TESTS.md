# Malware Detection Tests - Quick Reference

**PRIORITY**: P0 (Critical) - Core Sentinel Security Feature

10 comprehensive tests for YARA-based malware detection with ML enhancement.

## Quick Start

```bash
# Run all malware tests
npx playwright test tests/security/malware-detection.spec.ts --project=ladybird

# Run specific test
npx playwright test malware-detection.spec.ts -g "MAL-001"

# View test report
npx playwright show-report
```

## Test Coverage

| Test ID | Name | Purpose | Priority |
|---------|------|---------|----------|
| MAL-001 | Known Malware Signature | EICAR detection via YARA | P0 |
| MAL-002 | Clean File Scan | No false positives | P0 |
| MAL-003 | Quarantine System | File isolation | P0 |
| MAL-004 | User Decision Handling | PolicyGraph persistence | P0 |
| MAL-005 | ML-Based Detection | Zero-day detection | P0 |
| MAL-006 | Custom YARA Rules | Rule extensibility | P0 |
| MAL-007 | Large File Scanning | Performance & size strategies | P0 |
| MAL-008 | Concurrent Downloads | Worker pool parallelism | P0 |
| MAL-009 | Scan Result Caching | PolicyGraph optimization | P0 |
| MAL-010 | Edge Cases | Graceful degradation | P0 |

## Architecture

```
Browser Download → RequestServer → SecurityTap → Sentinel (YARA + ML) → Alert/Quarantine
                                                        ↓
                                                  PolicyGraph DB
```

## Test Files

```
fixtures/malware/
├── eicar.txt               # EICAR test string (safe)
├── clean-file.txt          # Legitimate file
├── clean-file2.txt         # Another clean file
├── custom-test.txt         # Custom YARA rule test
└── ml-suspicious.bin       # ML detection test
```

## YARA Rules

```
fixtures/yara/
├── test-rules.yar          # Test YARA rules
└── README.md               # YARA documentation
```

**Rules**:
- `EICAR_Test_File` - EICAR signature
- `Detect_Test_String` - Custom test pattern
- `PE_Suspicious_APIs` - Windows malware APIs
- `Embedded_URLs` - C2 server URLs
- `Suspicious_PowerShell` - PowerShell attacks
- (More rules in test-rules.yar)

## Prerequisites

1. **Sentinel Service Running**:
   ```bash
   # Start Sentinel
   ./Build/release/bin/Sentinel

   # Or via systemd
   sudo systemctl start sentinel
   ```

2. **YARA Rules Installed**:
   ```bash
   sudo cp fixtures/yara/test-rules.yar /etc/sentinel/rules/
   sudo systemctl reload sentinel
   ```

3. **Test Server Running**:
   ```bash
   # Automatically started by Playwright
   # Or manually:
   node test-server.js
   ```

## Test Endpoints

- `http://localhost:8080/malware/eicar.txt` - EICAR test file
- `http://localhost:8080/malware/clean-file.txt` - Clean file
- `http://localhost:8080/malware/ml-suspicious.bin` - ML test
- `http://localhost:8080/malware-info` - List all test files

## Expected Behavior

### MAL-001: EICAR Detection
✅ SecurityTap detects EICAR signature
✅ Alert shown: "EICAR_Test_File"
✅ Download blocked

### MAL-002: Clean File
✅ No YARA matches
✅ Low ML probability (< 0.1)
✅ Download allowed

### MAL-005: ML Detection
✅ High entropy (7.8+)
✅ Suspicious APIs detected
✅ ML probability > 0.85
✅ Alert: "ML-based detection"

## Common Issues

### Sentinel Not Running
```bash
# Error: Failed to connect to /tmp/sentinel.sock
# Solution:
./Build/release/bin/Sentinel
```

### YARA Rules Not Loading
```bash
# Check syntax:
yara -w fixtures/yara/test-rules.yar

# Verify installed:
ls -la /etc/sentinel/rules/
```

### Downloads Not Scanning
```bash
# Enable debug logging:
REQUESTSERVER_DEBUG=1 ./Build/release/bin/Ladybird
# Should see: "SecurityTap: Connected to Sentinel daemon"
```

## Integration Points

**SecurityTap** (`Services/RequestServer/SecurityTap.cpp`):
- `inspect_download()` - Synchronous scan
- `async_inspect_download()` - Worker pool scan
- `scan_with_size_limits()` - Size-based strategies

**MalwareML** (`Services/Sentinel/MalwareML.cpp`):
- `extract_features()` - Feature extraction
- `predict()` - ML inference
- `analyze_file()` - Combined analysis

**PolicyGraph** (`Services/Sentinel/PolicyGraph.cpp`):
- `get_scan_result()` - Cache lookup
- `create_scan_result()` - Store verdict
- `scan_results` table - Persistence

## Performance Benchmarks

| File Size | Strategy | Expected Time | Memory |
|-----------|----------|---------------|--------|
| < 5MB | Full scan | < 500ms | < 5MB |
| 5-50MB | Streaming | < 2s | < 5MB |
| 50-100MB | Partial scan | < 2s | < 10MB |
| > 100MB | Skip | < 10ms | Minimal |

## Helper Utilities

Located in `helpers/malware-test-helpers.ts`:

```typescript
// Compute file hash
const sha256 = computeSHA256(content);

// Calculate entropy
const entropy = computeEntropy(buffer);

// Create test files
createEICARFile('test.txt');
createMLSuspiciousFile('suspicious.bin');

// Mock Sentinel responses
const response = mockSentinelEICARResponse();
```

## Documentation

**Comprehensive Guide**: `MALWARE_TESTING_GUIDE.md` (this directory)

**Topics**:
- Detailed test descriptions
- Architecture diagrams
- Sentinel integration
- YARA rule writing
- ML feature engineering
- PolicyGraph queries
- Troubleshooting guide
- Advanced topics

## Security Notes

⚠️ **IMPORTANT**:
- All test files are SAFE (EICAR, synthetic samples)
- Do NOT use real malware
- Test files won't harm your system
- EICAR is industry-standard AV test string
- ML samples are crafted, not actual threats

## CI/CD Integration

```yaml
# .github/workflows/playwright.yml
- name: Run Malware Detection Tests
  run: |
    # Start Sentinel
    ./Build/release/bin/Sentinel &

    # Install YARA rules
    sudo cp fixtures/yara/test-rules.yar /etc/sentinel/rules/

    # Run tests
    npx playwright test malware-detection.spec.ts
```

## Metrics

**Test Coverage**:
- 10 tests covering all major scenarios
- YARA detection: 3 tests
- ML detection: 2 tests
- PolicyGraph: 2 tests
- Performance: 2 tests
- Edge cases: 1 test

**Code Coverage** (Sentinel components):
- SecurityTap: ~80%
- MalwareMLDetector: ~70%
- YARAScanWorkerPool: ~75%
- PolicyGraph (scan_results): ~60%

## Related Tests

- **FormMonitor**: `form-monitor.spec.ts` (credential protection)
- **PolicyGraph**: `policy-graph.spec.ts` (database operations)
- **Fingerprinting**: `fingerprinting.spec.ts` (browser fingerprinting)

## Maintenance

**Update Frequency**: Weekly (YARA rules), Monthly (test files)

**Responsibilities**:
- Update YARA rules as new threats emerge
- Retrain ML model quarterly
- Review PolicyGraph schema changes
- Monitor false positive rates

## Contact

For questions or issues with malware detection tests:
- Check `MALWARE_TESTING_GUIDE.md` first
- Review Sentinel logs: `sudo journalctl -u sentinel`
- Consult `docs/SENTINEL_ARCHITECTURE.md`

---

**Status**: ✅ Ready for testing (10/10 tests implemented)

**Last Updated**: 2025-11-01
